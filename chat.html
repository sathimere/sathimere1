<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere - Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#ffe6f2;}
.topbar{
    height:55px;background:#ff4fa5;color:#fff;
    display:flex;align-items:center;
    padding:0 15px;font-size:20px;
    position:fixed;width:100%;top:0;z-index:10;
}
.topbar img{width:35px;height:35px;border-radius:50%;margin-right:10px;}
.topbar span{flex:1;text-align:center;}

.chat-box{
    margin-top:65px;margin-bottom:70px;
    padding:10px;
}
.msg{
    max-width:75%;padding:10px 14px;border-radius:15px;
    margin:6px 0;display:inline-block;
    font-size:15px;
}
.me{
    background:#ff4fa5;color:#fff;margin-left:auto;border-bottom-right-radius:0;
}
.other{
    background:#fff;color:#333;border-bottom-left-radius:0;
}

.sendBar{
    position:fixed;bottom:0;width:100%;
    background:#fff;padding:10px;
    display:flex;gap:10px;border-top:1px solid #ddd;
}
.sendBar input{
    flex:1;padding:10px;font-size:16px;
    border-radius:10px;border:1px solid #ccc;
}
.sendBar button{
    background:#ff1493;color:#fff;border:none;
    padding:10px 15px;font-size:16px;
    border-radius:10px;cursor:pointer;
}
</style>
</head>

<body>

<div class="topbar">
    <div onclick="history.back()" style="cursor:pointer;font-size:22px;">‚Üê</div>
    <img id="userPhoto" src="">
    <span id="userName">Chat</span>
</div>

<div class="chat-box" id="chatBox"></div>

<div class="sendBar">
    <input id="msgInput" placeholder="Type message...">
    <button onclick="sendMsg()">Send</button>
</div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let CURRENT=null;
let CHATID="";
let OTHER_UID="";

/* GET CHAT ID FROM URL */
const params = new URLSearchParams(location.search);
CHATID = params.get("id");

if(!CHATID){ alert("Chat ID missing!"); }

/* INIT */
auth.onAuthStateChanged(async user=>{
    if(!user){ location.href="login.html"; return; }
    CURRENT = user;

    loadChatHeader();
    loadMessages();
});

/* LOAD CHAT HEADER USER INFO (NAME + DP) */
async function loadChatHeader(){
    let users = CHATID.split("_");
    OTHER_UID = users[0]===CURRENT.uid ? users[1] : users[0];

    let u = await db.collection("users").doc(OTHER_UID).get();
    let d = u.data();

    userName.innerText = d.name + " " + (d.surname || "");
    userPhoto.src = d.photo || "https://via.placeholder.com/150";
}

/* REAL-TIME MESSAGES */
function loadMessages(){
    db.collection("chats").doc(CHATID)
      .collection("messages")
      .orderBy("time","asc")
      .onSnapshot(snapshot=>{
          chatBox.innerHTML="";
          snapshot.forEach(doc=>{
              let m = doc.data();

              let div = document.createElement("div");
              div.className = "msg " + (m.from===CURRENT.uid ? "me" : "other");
              div.innerText = m.text;

              chatBox.appendChild(div);
          });

          chatBox.scrollTop = chatBox.scrollHeight;
      });
}

/* SEND MESSAGE */
async function sendMsg(){
    let text = msgInput.value.trim();
    if(text==="") return;

    await db.collection("chats").doc(CHATID)
      .collection("messages")
      .add({
          text:text,
          from:CURRENT.uid,
          to:OTHER_UID,
          time:Date.now()
      });

    await db.collection("chats").doc(CHATID).update({
        lastMsg:text,
        time:Date.now()
    });

    msgInput.value="";
}
</script>

</body>
</html>
