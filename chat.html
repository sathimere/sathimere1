<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f6f6f6;}

.topbar{
    height:55px;background:#ff4fa5;color:#fff;
    display:flex;align-items:center;gap:10px;
    padding:0 15px;font-size:18px;
    position:fixed;width:100%;top:0;z-index:10;
}
.topbar img{
    width:38px;height:38px;border-radius:50%;object-fit:cover;
}
.username{font-weight:bold;}

.chat-box{
    margin-top:65px;margin-bottom:75px;
    padding:10px;
}

.msg{
    max-width:75%;padding:10px 14px;border-radius:18px;
    margin:6px 0;font-size:15px;line-height:1.4;
}
.me{
    background:#ff4fa5;color:#fff;
    margin-left:auto;border-bottom-right-radius:4px;
}
.them{
    background:#fff;border:1px solid #ddd;
    margin-right:auto;border-bottom-left-radius:4px;
}

.bottom{
    position:fixed;bottom:0;width:100%;
    display:flex;gap:5px;background:#fff;padding:10px;
    border-top:1px solid #ddd;
}
.input{
    flex:1;padding:12px;border-radius:20px;
    border:1px solid #ccc;outline:none;
    font-size:15px;background:#fafafa;
}
.send{
    background:#ff4fa5;color:#fff;border:none;
    padding:12px 18px;border-radius:20px;font-size:15px;
}
</style>
</head>

<body>

<!-- TOP SECTION -->
<div class="topbar" id="topBar">
    <span onclick="history.back()" style="font-size:22px;cursor:pointer;">‚Üê</span>
    <img id="userPhoto">
    <span class="username" id="userName">Loading...</span>
</div>

<!-- CHAT AREA -->
<div class="chat-box" id="chatBox"></div>

<!-- SEND BOX -->
<div class="bottom">
    <input id="msgInput" class="input" placeholder="Message..." />
    <button class="send" onclick="sendMsg()">Send</button>
</div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* GET CHAT ID */
const urlParams = new URLSearchParams(location.search);
let chatID = urlParams.get("id");

let CURRENT = null;
let OTHER = null;

/* INIT */
auth.onAuthStateChanged(async u=>{
    if(!u){ location.href="login.html"; return; }
    CURRENT = u.uid;

    loadChatHeader();
    loadMessages();
});

/* LOAD CHAT HEADER (USER PHOTO + NAME) */
async function loadChatHeader(){
    let parts = chatID.split("_");
    OTHER = (parts[0] === CURRENT) ? parts[1] : parts[0];

    let user = await db.collection("users").doc(OTHER).get();
    let u = user.data();

    userPhoto.src = u.photo || "https://via.placeholder.com/150";
    userName.innerText = u.name + " " + (u.surname || "");
}

/* LOAD MESSAGES REAL TIME */
function loadMessages(){
    db.collection("messages").doc(chatID)
    .onSnapshot(doc=>{
        let d = doc.data();
        let list = d?.messages || [];

        chatBox.innerHTML = "";

        list.forEach(m=>{
            let div = document.createElement("div");
            div.className = "msg " + (m.sender === CURRENT ? "me" : "them");
            div.innerText = m.text;
            chatBox.appendChild(div);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    });
}

/* SEND MESSAGE */
async function sendMsg(){
    let text = msgInput.value.trim();
    if(text==="") return;

    let msgObj = {
        sender: CURRENT,
        text: text,
        time: Date.now()
    };

    await db.collection("messages").doc(chatID).set({
        messages: firebase.firestore.FieldValue.arrayUnion(msgObj)
    }, {merge:true});

    await db.collection("chats").doc(chatID).update({
        lastMsg: text,
        time: Date.now()
    });

    msgInput.value = "";
}
</script>

</body>
    </html>
