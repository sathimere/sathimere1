<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere â€“ Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {margin:0;font-family:'Segoe UI',sans-serif;background:#fafafa;}
.container{display:flex;height:100vh;}
.sidebar{width:35%;background:#fff;border-right:1px solid #ddd;display:flex;flex-direction:column;}
.title{padding:15px;font-size:22px;font-weight:bold;border-bottom:1px solid #ddd;background:linear-gradient(to right,#ff416c,#ff4fa5);color:#fff;}
.section-title{padding:10px 15px;font-size:14px;color:#777;background:#f0f0f0;border-bottom:1px solid #ddd;}
.user-item{display:flex;align-items:center;padding:10px;cursor:pointer;border-bottom:1px solid #eee;transition:0.2s;}
.user-item:hover{background:#f9f9f9;}
.user-item img{width:45px;height:45px;border-radius:50%;margin-right:10px;object-fit:cover;}
.user-info{flex-grow:1;}
.user-info .name{font-weight:bold;}
.user-info .lastmsg{font-size:12px;color:#777;}
.btn-box button{margin-left:5px;padding:5px 10px;border:none;border-radius:5px;cursor:pointer;font-size:12px;}
.accept{background:#4caf50;color:#fff;}
.reject{background:#f44336;color:#fff;}
.chat-area{flex-grow:1;display:flex;flex-direction:column;background:#eaeaea;}
.chat-header{padding:15px;background:#fff;display:flex;align-items:center;border-bottom:1px solid #ddd;position:sticky;top:0;z-index:5;}
.chat-header img{width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:10px;}
.chat-box{flex-grow:1;padding:10px;overflow-y:auto;}
.msg{padding:10px 14px;margin:8px 0;max-width:70%;border-radius:20px;font-size:14px;line-height:18px;}
.me{background:#dcf8c6;margin-left:auto;}
.other{background:#fff;margin-right:auto;}
.chat-input{display:flex;padding:10px;background:#fff;border-top:1px solid #ddd;}
.chat-input input{flex-grow:1;padding:10px 15px;border:1px solid #ccc;border-radius:25px;outline:none;}
.chat-input button{margin-left:10px;padding:10px 20px;background:#ff4fa5;color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:bold;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2);border-radius:3px;}
</style>
</head>

<body>

<div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="title">Chats</div>

        <div class="section-title">Chat Requests</div>
        <div id="requests"></div>

        <div class="section-title">Accepted Chats</div>
        <div id="chats"></div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area">
        <div class="chat-header" id="chatHeader">
            <span>Select a chat</span>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="chat-input">
            <input id="msgInput" placeholder="Message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_APP",
    projectId: "YOUR_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "X",
    appId: "X"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let CURRENT = null;
let currentChatID = null;
let currentOther = null;

auth.onAuthStateChanged(u=>{
    if(!u){ location.href="login.html"; return; }
    CURRENT = u;
    loadRequests();
    loadChats();
});

/* --------------------- LOAD CHAT REQUESTS --------------------- */
function loadRequests(){
    db.collection("requests")
      .where("to","==",CURRENT.uid)
      .where("status","==","pending")
      .onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
            let d=doc.data();
            html+=`<div class="user-item">
                <img src="${d.fromPhoto||'https://via.placeholder.com/150'}"/>
                <div class="user-info"><div class="name">${d.fromName}</div></div>
                <div class="btn-box">
                    <button class="accept" onclick="acceptReq('${doc.id}','${d.from}')">Accept</button>
                    <button class="reject" onclick="rejectReq('${doc.id}')">Reject</button>
                </div>
            </div>`;
        });
        document.getElementById("requests").innerHTML = html;
    });
}

/* ACCEPT / REJECT */
function acceptReq(id,other){
    db.collection("requests").doc(id).update({status:"accepted"});
    const chatID = [CURRENT.uid, other].sort().join("_");
    db.collection("chats").doc(chatID).set({users:[CURRENT.uid,other],lastmsg:"",lasttime:Date.now()},{merge:true});
}

function rejectReq(id){
    db.collection("requests").doc(id).update({status:"rejected"});
}

/* --------------------- LOAD ACCEPTED CHATS --------------------- */
function loadChats(){
    db.collection("chats")
      .where("users","array-contains",CURRENT.uid)
      .orderBy("lasttime","desc")
      .onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
            let d=doc.data();
            let other=d.users.filter(u=>u!=CURRENT.uid)[0];
            html+=`<div class="user-item" onclick="openChat('${doc.id}','${other}')">
                <img src="https://via.placeholder.com/150"/>
                <div class="user-info">
                    <div class="name">${other}</div>
                    <div class="lastmsg">${d.lastmsg}</div>
                </div>
            </div>`;
        });
        document.getElementById("chats").innerHTML = html;
    });
}

/* --------------------- OPEN CHAT --------------------- */
function openChat(chatID,other){
    currentChatID = chatID;
    currentOther = other;
    document.getElementById("chatHeader").innerHTML = `<img src="https://via.placeholder.com/150"><div>${other}</div>`;
    loadMessages(chatID);
}

/* --------------------- REAL TIME MESSAGES --------------------- */
function loadMessages(chatID){
    db.collection("chats").doc(chatID)
      .collection("messages")
      .orderBy("time")
      .onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
            let d=doc.data();
            html+=`<div class="msg ${d.sender==CURRENT.uid?'me':'other'}">${d.text}</div>`;
        });
        document.getElementById("chatBox").innerHTML=html;
        document.getElementById("chatBox").scrollTop = 999999;
    });
}

/* --------------------- SEND MESSAGE --------------------- */
function sendMessage(){
    const text=document.getElementById("msgInput").value;
    if(!text || !currentChatID) return;
    const msg={text,sender:CURRENT.uid,time:Date.now()};
    db.collection("chats").doc(currentChatID).collection("messages").add(msg);
    db.collection("chats").doc(currentChatID).update({lastmsg:text,lasttime:Date.now()});
    document.getElementById("msgInput").value="";
}
</script>

</body>
</html>
