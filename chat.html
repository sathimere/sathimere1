<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere - Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {margin:0;font-family:Arial,sans-serif;background:#f2f2f2;}
.topbar {height:55px;background:#ff4fa5;color:#fff;display:flex;align-items:center;justify-content:center;position:fixed;width:100%;top:0;z-index:10;font-size:20px;}
.topbar span:first-child {position:absolute;left:15px;cursor:pointer;}
.topbar span:last-child {position:absolute;right:15px;cursor:pointer;}
.list {padding:10px;margin-top:65px;margin-bottom:80px;}
.card {background:#fff;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:10px;overflow:hidden;display:flex;align-items:center;padding:10px;}
.card img {width:60px;height:60px;border-radius:50%;object-fit:cover;margin-right:10px;}
.info {flex:1;}
.btn {padding:6px 12px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;font-size:14px;}
.accept {background:#28a745;color:#fff;}
.reject {background:#d9534f;color:#fff;}
.bottom-nav {position:fixed;bottom:0;width:100%;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:space-around;padding:8px 0;box-shadow:0 -3px 10px rgba(0,0,0,0.1);}
.bottom-nav div {text-align:center;color:#ff1493;font-weight:bold;display:flex;flex-direction:column;gap:3px;cursor:pointer;}
.icon {font-size:24px;}
</style>
</head>

<body>
<div class="topbar">
<span onclick="openMenu()">‚ò∞</span>Chat
<span onclick="logout()">‚èª</span>
</div>

<div id="menu" style="width:0;height:100%;position:fixed;top:0;left:0;background:#fff;overflow-x:hidden;transition:0.3s;padding-top:60px;box-shadow:3px 0 10px rgba(0,0,0,0.2);z-index:20;">
<a class="closebtn" onclick="closeMenu()">‚úñ</a>
<a href="index.html">Dashboard</a>
<a href="profile.html">My Profile</a>
<a href="wallet.html">Wallet</a>
<a href="help.html">Help & Support</a>
<a onclick="logout()">Logout</a>
</div>

<div class="list" id="requestList"></div>

<div class="bottom-nav">
<div onclick="location.href='index.html'">
<span class="icon">üè†</span>
Home
</div>
<div onclick="location.href='chat.html'">
<span class="icon">üí¨</span>
Chat
</div>
<div onclick="location.href='profile.html'">
<span class="icon">üë§</span>
Profile
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let CURRENT = null;

/* MENU */
function openMenu(){ menu.style.width="250px"; }
function closeMenu(){ menu.style.width="0"; }
function logout(){ auth.signOut().then(()=>location.href="login.html"); }

/* INIT */
auth.onAuthStateChanged(async u=>{
    if(!u){ location.href="login.html"; return; }
    CURRENT = u;
    loadChatRequests();
});

/* LOAD CHAT REQUESTS (INCOMING + SENT ACCEPTED) */
async function loadChatRequests(){
    const list = document.getElementById('requestList');
    list.innerHTML = "";

    // Incoming requests
    const incoming = await db.collection("requests").where("to","==",CURRENT.uid).get();
    for(let d of incoming.docs){
        const r = d.data();
        const userDoc = await db.collection("users").doc(r.from).get();
        const u = userDoc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b> wants to chat
            </div>
            <button class="btn accept" onclick="acceptRequest('${d.id}','${r.from}')">Accept</button>
            <button class="btn reject" onclick="rejectRequest('${d.id}')">Reject</button>
        `;
        list.appendChild(card);
    }

    // Accepted requests (for chat list)
    const accepted = await db.collection("requests").where("status","==","accepted").where("to","==",CURRENT.uid).get();
    for(let d of accepted.docs){
        const r = d.data();
        const userDoc = await db.collection("users").doc(r.from).get();
        const u = userDoc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b> Chat
            </div>
            <button class="btn accept" onclick="openChat('${CURRENT.uid}','${r.from}')">Open Chat</button>
        `;
        list.appendChild(card);
    }

    // Requests sent by me and accepted
    const sentAccepted = await db.collection("requests").where("from","==",CURRENT.uid).where("status","==","accepted").get();
    for(let d of sentAccepted.docs){
        const r = d.data();
        const userDoc = await db.collection("users").doc(r.to).get();
        const u = userDoc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b> Chat
            </div>
            <button class="btn accept" onclick="openChat('${CURRENT.uid}','${r.to}')">Open Chat</button>
        `;
        list.appendChild(card);
    }
}

/* ACCEPT REQUEST ‚Üí Create chat room */
async function acceptRequest(id, other){
    await db.collection("requests").doc(id).update({status:"accepted"});
    // Create chat doc
    const chatID = CURRENT.uid < other ? CURRENT.uid + "_" + other : other + "_" + CURRENT.uid;
    await db.collection("chats").doc(chatID).set({users:[CURRENT.uid,other],lastMsg:"",time:Date.now()});
    loadChatRequests();
}

/* REJECT REQUEST ‚Üí Delete */
async function rejectRequest(id){
    await db.collection("requests").doc(id).delete();
    loadChatRequests();
}

/* OPEN CHAT */
function openChat(uid1, uid2){
    const chatID = uid1 < uid2 ? uid1+"_"+uid2 : uid2+"_"+uid1;
    location.href = "chat-room.html?id="+chatID;
}
</script>
</body>
    </html>
