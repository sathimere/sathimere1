<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>
<style>
body { font-family: Arial; background: #ffe4f0; margin:0; padding:0; }
.header { background:#ff1493; padding:15px; color:#fff; text-align:center; font-size:22px; font-weight:bold; position:fixed; top:0; width:100%; z-index:10; }
.container { padding:80px 15px 70px; }
.section-title { margin-top:15px; font-weight:bold; color:#ff1493; font-size:18px; margin-bottom:10px; }
.request-card { background:white; margin-bottom:10px; padding:10px 15px; border-radius:12px; display:flex; align-items:center; box-shadow:0 0 10px #ffc0d9; position:relative; }
.request-card img { width:50px; height:50px; border-radius:50%; object-fit:cover; border:3px solid #ff1493; margin-right:10px; }
.name { font-weight:bold; color:#ff1493; }
.btn { background:#ff1493; color:white; border:none; border-radius:8px; padding:6px 12px; margin-left:5px; cursor:pointer; }
.btn-disabled { background:gray; }
/* Online dot */
.online-dot { position:absolute; width:12px; height:12px; border-radius:50%; background:green; bottom:5px; left:45px; border:2px solid white; }
/* Bottom Back Button */
#backBtn { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); background:#ff1493; color:white; border:none; border-radius:25px; padding:10px 20px; font-weight:bold; cursor:pointer; z-index:10; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
</style>
</head>
<body>

<div class="header">Chat Requests</div>
<div class="container" id="requestList">Loading...</div>

<button id="backBtn" onclick="goBack()">‚Üê Back to Home</button>

<script>
let CURRENT = null;

auth.onAuthStateChanged(async user=>{
    if(!user) return location.href="login.html";
    CURRENT = user;
    loadChatRequests();
});

function goBack(){ location.href="index.html"; }

async function loadChatRequests(){
    const container = document.getElementById("requestList");
    container.innerHTML = "Loading...";

    const incomingSnap = await db.collection("chatRequests")
        .where("to","==",CURRENT.uid)
        .where("status","==","pending").get();

    if(!incomingSnap.empty){
        const title = document.createElement("div");
        title.className = "section-title";
        title.innerText = "Incoming Requests";
        container.appendChild(title);

        for(let doc of incomingSnap.docs){
            const data = doc.data();
            const fromId = data.from;
            const card = await createCard(fromId, doc.id, true);
            container.appendChild(card);
        }
    }

    const acceptedSnap = await db.collection("chatRequests")
        .where("status","==","accepted")
        .get();

    let hasAccepted = false;
    for(let doc of acceptedSnap.docs){
        const data = doc.data();
        const fromId = data.from;
        const toId = data.to;

        if(fromId===CURRENT.uid || toId===CURRENT.uid){
            if(!hasAccepted){
                const title = document.createElement("div");
                title.className = "section-title";
                title.innerText = "Chats";
                container.appendChild(title);
                hasAccepted = true;
            }
            const otherId = fromId===CURRENT.uid ? toId : fromId;
            const card = await createCard(otherId, doc.id, false);
            container.appendChild(card);
        }
    }

    if(container.innerHTML==="Loading...") container.innerHTML="No requests or chats.";
}

async function createCard(userId, requestId, isPending){
    const userDoc = await db.collection("users").doc(userId).get();
    const u = userDoc.data();

    // Check online status
    const chatID = CURRENT.uid < userId ? CURRENT.uid+"_"+userId : userId+"_"+CURRENT.uid;
    const chatDoc = await db.collection("chats").doc(chatID).get();
    const isOnline = chatDoc.exists ? chatDoc.data()[userId+"_online"]===true : false;

    const card = document.createElement("div");
    card.className = "request-card";

    const imgWrapper = document.createElement("div");
    imgWrapper.style.position = "relative";
    const img = document.createElement("img");
    img.src = u.photo||'https://i.imgur.com/6VBx3io.png';
    imgWrapper.appendChild(img);

    if(isOnline){
        const dot = document.createElement("div");
        dot.className = "online-dot";
        imgWrapper.appendChild(dot);
    }

    card.appendChild(imgWrapper);

    const infoDiv = document.createElement("div");
    infoDiv.style.flex = "1";
    infoDiv.innerHTML = `<div class="name">${u.name} ${u.surname}</div>
                         <div style="color:gray">${u.gender}</div>`;
    card.appendChild(infoDiv);

    if(isPending){
        const acceptBtn = document.createElement("button");
        acceptBtn.className = "btn";
        acceptBtn.innerText = "Accept";
        acceptBtn.onclick = ()=>acceptRequest(requestId, u.gender, userId);
        const rejectBtn = document.createElement("button");
        rejectBtn.className = "btn";
        rejectBtn.innerText = "Reject";
        rejectBtn.onclick = ()=>rejectRequest(requestId, card);
        card.appendChild(acceptBtn);
        card.appendChild(rejectBtn);
    } else {
        const openBtn = document.createElement("button");
        openBtn.className = "btn";
        openBtn.innerText = "Open Chat";
        openBtn.onclick = ()=>openChat(CURRENT.uid, userId);
        card.appendChild(openBtn);
    }

    return card;
}

async function acceptRequest(requestId, fromGender, fromId){
    const req = await db.collection("chatRequests").doc(requestId).get();
    if(!req.exists) return;

    let myId = CURRENT.uid;
    let paidBy = req.data().paidBy || "Male";

    if(paidBy==="Male" && fromGender==="Female"){
        let wallet = await db.collection("wallets").doc(myId).get();
        let balance = wallet.exists ? wallet.data().balance : 0;

        if(balance >= 10){
            await db.collection("wallets").doc(myId).update({balance: balance - 10});
            await db.collection("history").add({uid: myId, amount:-10, type:"Chat Request Accepted", time:new Date()});
        } else { 
            alert("Insufficient balance!"); 
            return; 
        }
    }

    await db.collection("chatRequests").doc(requestId).update({status:"accepted"});

    const chatID = myId < fromId ? myId+"_"+fromId : fromId+"_"+myId;
    await db.collection("chats").doc(chatID).set({
        users:[myId, fromId],
        lastMsg:"", 
        time:Date.now()
    });

    location.href = "chat-room.html?id="+chatID;
}

async function rejectRequest(requestId, cardElem){
    await db.collection("chatRequests").doc(requestId).update({status:"rejected"});
    cardElem.remove();
}

function openChat(uid1, uid2){
    const chatID = uid1<uid2 ? uid1+"_"+uid2 : uid2+"_"+uid1;
    location.href = "chat-room.html?id="+chatID;
}
</script>
</body>
</html>
