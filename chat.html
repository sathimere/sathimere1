<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Chat Requests</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>
<style>
body { font-family: Arial; background: #ffe4f0; margin: 0; padding: 0; }
.header { background: #ff1493; padding: 15px; color: white; text-align: center; font-size: 22px; font-weight: bold; position: fixed; top: 0; width: 100%; }
.container { padding: 80px 15px; }
.request-card { background: white; margin-bottom: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 0 10px #ffc0d9; display: flex; align-items: center; }
.request-card img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid #ff1493; margin-right: 15px; }
.name { font-weight: bold; color: #ff1493; }
.btn { background: #ff1493; color: white; border: none; border-radius: 8px; margin-top: 5px; padding: 7px 12px; cursor: pointer; }
.btn-disabled { background: gray; }
</style>
</head>
<body>

<div class="header">Chat Requests</div>
<div class="container" id="requestList">Loading...</div>

<script>
auth.onAuthStateChanged(async (user) => {
if(!user) return window.location = "login.html";
loadRequests(user.uid);
});

async function loadRequests(myId){
const list = document.getElementById("requestList");
list.innerHTML = "Loading...";

// Get my requests where I am the "to" user
db.collection("chatRequests")
.where("to","==",myId)
.onSnapshot(async snap => {
list.innerHTML = "";
snap.forEach(async doc => {
    let data = doc.data();
    let fromId = data.from;
    let requestId = doc.id;

    let userDoc = await db.collection("users").doc(fromId).get();
    let u = userDoc.data();

    let card = document.createElement("div");
    card.className = "request-card";

    card.innerHTML = `
        <img src="${u.photo || 'https://i.imgur.com/6VBx3io.png'}">
        <div style="flex:1">
            <div class="name">${u.name} ${u.surname}</div>
            <div style="color:gray">${u.gender}</div>
            <button id="accept_${requestId}" class="btn">Accept</button>
            <button id="reject_${requestId}" class="btn">Reject</button>
        </div>
    `;

    list.appendChild(card);

    document.getElementById("accept_" + requestId).onclick = () => acceptRequest(myId, requestId, u.gender);
    document.getElementById("reject_" + requestId).onclick = () => rejectRequest(requestId);
});
});
}

async function acceptRequest(myId, requestId, fromGender){
let req = await db.collection("chatRequests").doc(requestId).get();
if(!req.exists) return;

let fromId = req.data().from;
let paidBy = req.data().paidBy || "Male";

// Male deduct logic
if(paidBy === "Male" && fromGender === "Female"){
    let wallet = await db.collection("wallet").doc(myId).get();
    let balance = wallet.exists ? wallet.data().balance : 0;
    if(balance >= 10){
        await db.collection("wallet").doc(myId).update({balance: balance - 10});
        await db.collection("history").add({uid: myId, amount: -10, type: "Chat Request Accepted", time: new Date()});
    } else {
        alert("Insufficient balance to accept this request!");
        return;
    }
}

// Update request status
await db.collection("chatRequests").doc(requestId).update({status: "accepted"});
alert("Request accepted!");
}

async function rejectRequest(requestId){
await db.collection("chatRequests").doc(requestId).update({status: "rejected"});
alert("Request rejected!");
}
</script>
</body>
</html>
