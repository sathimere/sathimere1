<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere - Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff;color:#333;}
.topbar{height:55px;background:#ff4fa5;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 15px;font-size:20px;position:fixed;width:100%;top:0;z-index:10;}
.topbar span:first-child{position:absolute;left:15px;}
.topbar span:last-child{position:absolute;right:15px;}

#menu{width:0;height:100%;position:fixed;top:0;left:0;background:#fff;overflow-x:hidden;transition:0.3s;padding-top:60px;box-shadow:3px 0 10px rgba(0,0,0,0.2);z-index:20;}
#menu a{padding:12px 20px;display:block;font-size:18px;color:#333;text-decoration:none;}
#menu a:hover{background:#ffe0f1;}
.closebtn{position:absolute;top:10px;right:10px;font-size:30px;}

.section-title{text-align:center;color:#ff1493;font-size:20px;margin-top:70px;margin-bottom:10px;font-weight:bold;}

.list{padding:10px;margin-bottom:80px;}
.card{background:#fff;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:15px;overflow:hidden;}
.row{display:flex;align-items:center;}
.row img{width:90px;height:90px;object-fit:cover;border-radius:10px;margin:10px;}
.info{flex:1;padding:10px;font-size:16px;}
.btn{background:#ff1493;color:#fff;padding:8px 12px;margin:4px;border:none;border-radius:8px;cursor:pointer;font-size:15px;}

.accept{background:#28a745}
.reject{background:#d9534f}

/* ‚≠ê NEW BOTTOM NAV ‚Äì Professional & Trusted Look */
.bottom-nav{
    position:fixed;
    bottom:0;
    width:100%;
    background:#ffffff;
    border-top:1px solid #ddd;
    display:flex;
    justify-content:space-around;
    padding:8px 0;
    box-shadow:0 -3px 12px rgba(0,0,0,0.12);
}
.bottom-nav div{
    text-align:center;
    font-size:13px;
    color:#ff1493;
    font-weight:bold;
    display:flex;
    flex-direction:column;
    gap:4px;
}

.icon{
    font-size:26px;
    line-height:20px;
}
</style>
</head>

<body>

<div class="topbar">
<span onclick="openMenu()">‚ò∞</span>
Dashboard
<span onclick="logout()">‚èª</span>
</div>

<!-- MENU -->
<div id="menu">
<a class="closebtn" onclick="closeMenu()">‚úñ</a>
<a href="profile.html">My Profile</a>
<a href="wallet.html">Wallet</a>
<a href="help.html">Help & Support</a>
<a onclick="logout()">Logout</a>
</div>

<!-- INCOMING REQUESTS -->
<div class="section-title">Incoming Chat Requests üí¨</div>
<div class="list" id="reqList"></div>

<!-- LIKE SECTION -->
<div id="likeSection" style="display:none;">
<div class="section-title">Who Liked Me üíú</div>
<div class="list" id="likeList"></div>
</div>

<!-- ALL PROFILES -->
<div class="section-title">Profiles</div>
<div class="list" id="userList"></div>

<!-- ‚≠ê NEW PROFESSIONAL BOTTOM NAV (UPDATED) -->
<div class="bottom-nav">

    <div onclick="openLikes()">
        <span class="icon">üíú</span>
        Likes
    </div>

    <div onclick="loadRequests()">
        <span class="icon">üí¨</span>
        Chat Req
    </div>

    <div onclick="location.href='chat.html'">
        <span class="icon">‚úâÔ∏è</span>
        Messages
    </div>

    <div onclick="location.href='profile.html'">
        <span class="icon">üë§</span>
        Profile
    </div>

</div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let CURRENT = null;

function openMenu(){ menu.style.width="250px"; }
function closeMenu(){ menu.style.width="0"; }
function logout(){ auth.signOut().then(()=>location.href="login.html"); }

/* INIT */
auth.onAuthStateChanged(async u=>{
    if(!u){ location.href="login.html"; return; }
    CURRENT=u;
    loadUsers();
    loadRequests();
});

/* LIKE SECTION OPEN */
function openLikes(){
    likeSection.style.display="block";
    loadLikes();
}

/* LOAD USERS */
async function loadUsers(){
    let list=userList; list.innerHTML="";

    let me=await db.collection("users").doc(CURRENT.uid).get();
    let myGender=me.data().gender||"Male";
    let target = myGender==="Male" ? "Female" : "Male";

    let q=await db.collection("users").where("gender","==",target).get();

    q.forEach(doc=>{
        let u=doc.data();

        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
        <div class="row">
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b><br>
                Age: ${u.age||'-'}<br>
                <button class="btn" onclick="sendLike('${doc.id}')">üíú Like</button>
                <button class="btn" onclick="sendRequest('${doc.id}')">Chat Request</button>
                <button class="btn" onclick="viewProfile('${doc.id}')">View Profile</button>
            </div>
        </div>`;
        list.appendChild(card);
    });
}

/* SEND LIKE */
async function sendLike(uid){
    await db.collection("likes").add({
        from: CURRENT.uid,
        to: uid,
        time: Date.now()
    });
    alert("Liked!");
    loadLikes();
}

/* SEND REQUEST */
async function sendRequest(uid){
    await db.collection("requests").add({
        from: CURRENT.uid,
        to: uid,
        status: "pending",
        time: Date.now()
    });
    alert("Request Sent!");
    loadRequests();
}

/* LIKES */
async function loadLikes(){
    let list=likeList; list.innerHTML="";

    let q=await db.collection("likes").where("to","==",CURRENT.uid).get();

    for (let d of q.docs){
        let l=d.data();
        let user=await db.collection("users").doc(l.from).get();
        let u=user.data();

        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
        <div class="row">
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b> liked your profile üíú
            </div>
        </div>`;
        list.appendChild(card);
    }
}

/* REQUESTS */
async function loadRequests(){
    let list=reqList; list.innerHTML="";

    let q=await db.collection("requests").where("to","==",CURRENT.uid).get();

    for(let d of q.docs){
        let r=d.data();
        let user=await db.collection("users").doc(r.from).get();
        let u=user.data();

        let card=document.createElement("div");
        card.className="card";

        card.innerHTML=`
        <div class="row">
            <img src="${u.photo||'https://via.placeholder.com/150'}">
            <div class="info">
                <b>${u.name} ${u.surname}</b> sent you a chat request
                <br>
                <button class="btn accept" onclick="acceptReq('${d.id}','${r.from}')">Accept</button>
                <button class="btn reject" onclick="rejectReq('${d.id}')">Reject</button>
            </div>
        </div>`;
        list.appendChild(card);
    }
}

/* ACCEPT ‚Üí CREATE CHAT */
async function acceptReq(id, other){
    await db.collection("requests").doc(id).update({status:"accepted"});

    let chatID = CURRENT.uid < other ?
                 CURRENT.uid+"_"+other : other+"_"+CURRENT.uid;

    await db.collection("chats").doc(chatID).set({
        users:[CURRENT.uid, other],
        lastMsg:"",
        time:Date.now()
    });

    location.href = "chat.html?id=" + chatID; 
}

async function rejectReq(id){
    await db.collection("requests").doc(id).delete(); 
    loadRequests();
}

function viewProfile(uid){
    location.href="profile-view.html?id="+uid;
}
</script>

</body>
    </html>
