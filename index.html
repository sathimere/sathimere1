<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SathiMere - Match</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    body {
        margin:0;
        font-family: Arial;
        background:#fff;
        color:#333;
    }

    /* Top bar */
    .topbar {
        height:55px;
        background:#ff4fa5;
        color:#fff;
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 15px;
        font-size:20px;
        position:fixed;
        width:100%;
        top:0;
        z-index:10;
    }

    /* Sidebar menu */
    #menu {
        width:0;
        height:100%;
        position:fixed;
        top:0;
        left:0;
        background:#fff;
        overflow-x:hidden;
        transition:0.3s;
        padding-top:60px;
        box-shadow:3px 0 10px rgba(0,0,0,0.2);
        z-index:20;
    }
    #menu a {
        padding:12px 20px;
        display:block;
        font-size:18px;
        color:#333;
        text-decoration:none;
    }
    #menu a:hover { background:#ffe0f1; }

    .closebtn {
        position:absolute;
        top:10px;
        right:10px;
        font-size:30px;
    }

    /* Match card */
    .card {
        width:90%;
        margin:90px auto 80px;
        background:#fff;
        border-radius:15px;
        box-shadow:0 4px 15px rgba(0,0,0,0.1);
        overflow:hidden;
        text-align:center;
    }

    .card img {
        width:100%;
        height:280px;
        object-fit:cover;
    }

    .details {
        padding:15px;
        font-size:18px;
    }

    /* Buttons */
    .btn {
        background:#ff4fa5;
        color:#fff;
        padding:12px 20px;
        border-radius:10px;
        display:inline-block;
        margin:10px;
        text-decoration:none;
        font-weight:bold;
    }

    /* Bottom navigation */
    .bottom-nav {
        position:fixed;
        bottom:0;
        width:100%;
        background:#fff;
        border-top:1px solid #ddd;
        display:flex;
        justify-content:space-around;
        padding:10px 0;
        box-shadow:0 -2px 10px rgba(0,0,0,0.1);
    }
    .bottom-nav div {
        text-align:center;
        font-size:14px;
        color:#ff4fa5;
        font-weight:bold;
        display:flex;
        flex-direction:column;
        gap:3px;
    }

    /* small icons */
    .icon {
        font-size:20px;
    }

    /* Filter popup */
    #filterBox {
        position:fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.4);
        display:none;
        justify-content:center;
        align-items:center;
        z-index:50;
    }

    .filter-card {
        width:85%;
        background:#fff;
        padding:20px;
        border-radius:15px;
        box-shadow:0 4px 20px rgba(0,0,0,0.2);
    }

    .filter-card input,
    .filter-card select {
        width:100%;
        padding:10px;
        margin:10px 0;
        border-radius:8px;
        border:1px solid #ccc;
    }

    .f-btn {
        width:100%;
        background:#ff4fa5;
        padding:12px;
        border-radius:10px;
        color:#fff;
        margin-top:10px;
        font-weight:bold;
        text-align:center;
    }

</style>

</head>
<body>

<!-- Top Bar -->
<div class="topbar">
    <span onclick="openMenu()">‚ò∞</span>
    SathiMere
    <span onclick="openFilter()">‚öô</span>
</div>

<!-- Sidebar Menu -->
<div id="menu">
    <a class="closebtn" onclick="closeMenu()">‚úñ</a>
    <a href="profile.html">My Profile</a>
    <a href="wallet.html">Wallet</a>
    <a href="terms.html">Terms & Conditions</a>
    <a href="privacy.html">Privacy Policy</a>
    <a href="help.html">Help & Support</a>
    <a onclick="logout()">Logout</a>
</div>

<!-- FILTER POPUP -->
<div id="filterBox">
    <div class="filter-card">
        <h3>Filter Profiles</h3>

        <input type="number" id="fAge" placeholder="Age (e.g. 18-30)">
        <input type="text" id="fState" placeholder="State">
        <input type="text" id="fCaste" placeholder="Caste">
        <input type="text" id="fChoice" placeholder="Choice">

        <div class="f-btn" onclick="applyFilter()">Apply Filter</div>
        <div class="f-btn" style="background:#bbb" onclick="closeFilter()">Close</div>
    </div>
</div>

<!-- Match Card -->
<div id="matchCard" class="card" style="display:none;">
    <img id="pPhoto">
    <div class="details">
        <div id="pName"></div>
        <div id="pAge"></div>
        <div id="pBio"></div>
    </div>

    <!-- NEW MATCH BUTTON -->
    <a class="btn" onclick="goMatch()">Match</a>
    <a class="btn" onclick="viewProfile()">View Profile</a>
    <a class="btn" onclick="startChat()">Chat</a>
    <a class="btn" onclick="nextProfile()">Next</a>
</div>

<div style="margin-top:180px;text-align:center;" id="loadingTxt">Loading matches...</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div onclick="location.href='profile.html'">
        <span class="icon">üë§</span>
        Profile
    </div>

    <div onclick="location.href='index.html'">
        <span class="icon">‚ù§Ô∏è</span>
        Match
    </div>

    <div onclick="openChat()">
        <span class="icon">üí¨</span>
        Chat
    </div>
</div>

<script>
/* ---------------- Firebase Init ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* UI Menu */
function openMenu(){ document.getElementById("menu").style.width="250px"; }
function closeMenu(){ document.getElementById("menu").style.width="0"; }

/* Filter */
function openFilter(){ document.getElementById("filterBox").style.display="flex"; }
function closeFilter(){ document.getElementById("filterBox").style.display="none"; }

let filters = {};

function applyFilter(){
    filters = {
        age: document.getElementById("fAge").value,
        state: document.getElementById("fState").value,
        caste: document.getElementById("fCaste").value,
        choice: document.getElementById("fChoice").value
    };
    closeFilter();
    loadMatches();
}

/* Chat */
function openChat(){
    location.href="chat.html";
}

/* Logout */
function logout(){
    firebase.auth().signOut().then(()=>{ location.href="login.html"; });
}

let currentUser = null;
let profiles = [];
let currentIndex = 0;
let currentProfileId = null;

/* Load after login */
firebase.auth().onAuthStateChanged(async(user)=>{
    if(!user){ location.href="login.html"; return; }

    currentUser = user;
    loadMatches();
});

/* Load matches with filters */
async function loadMatches(){
    let myData = await db.collection("profiles").doc(currentUser.uid).get();
    if(!myData.exists){ return; }

    let me = myData.data();
    let opposite = me.gender === "male" ? "female" : "male";

    let q = await db.collection("profiles").where("gender","==",opposite).get();

    profiles = [];

    q.forEach(doc=>{
        let d = doc.data();

        /* Apply filters */
        if(filters.state && d.state !== filters.state) return;
        if(filters.caste && d.caste !== filters.caste) return;
        if(filters.choice && d.choice !== filters.choice) return;

        if(filters.age){
            let parts = filters.age.split("-");
            if(parts.length === 2){
                let min = parseInt(parts[0]);
                let max = parseInt(parts[1]);
                if(d.age < min || d.age > max) return;
            }
        }

        if(doc.id !== currentUser.uid){
            profiles.push({ id: doc.id, ...d });
        }
    });

    if(profiles.length === 0){
        document.getElementById("loadingTxt").innerText = "No matches found.";
        return;
    }

    document.getElementById("loadingTxt").style.display="none";
    document.getElementById("matchCard").style.display="block";
    showProfile();
}

function showProfile(){
    let p = profiles[currentIndex];
    currentProfileId = p.id;

    document.getElementById("pPhoto").src = p.photo || "https://via.placeholder.com/300x300?text=No+Photo";
    document.getElementById("pName").innerText = p.name;
    document.getElementById("pAge").innerText = "Age: " + p.age;
    document.getElementById("pBio").innerText = p.bio || "";
}

function nextProfile(){
    currentIndex++;
    if(currentIndex >= profiles.length) currentIndex = 0;
    showProfile();
}

function viewProfile(){
    location.href = "profile-view.html?id=" + currentProfileId;
}

function startChat(){
    location.href = "chat.html?uid=" + currentProfileId;
}

/* NEW: match button */
function goMatch(){
    location.href = "match.html?uid=" + currentProfileId;
}

</script>

</body>
        </html>
