<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SathiMere - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff;color:#333;}
.topbar{height:55px;background:#ff4fa5;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 15px;font-size:20px;position:fixed;width:100%;top:0;z-index:10;}
#menu{width:0;height:100%;position:fixed;top:0;left:0;background:#fff;overflow-x:hidden;transition:0.3s;padding-top:60px;box-shadow:3px 0 10px rgba(0,0,0,0.2);z-index:20;}
#menu a{padding:12px 20px;display:block;font-size:18px;color:#333;text-decoration:none;}
#menu a:hover{background:#ffe0f1;}
.closebtn{position:absolute;top:10px;right:10px;font-size:30px;}
.scroll-list{margin-top:65px; max-height:calc(100vh - 120px); overflow-y:auto; padding:10px;}
.card{background:#fff;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:15px;overflow:hidden;}
.card img{width:100%;height:200px;object-fit:cover;}
.details{padding:12px;font-size:16px;text-align:center;}
.like-btn,.chat-btn,.view-btn,.accept-btn,.reject-btn{background:#ff1493;color:#fff;padding:8px 12px;margin:5px;border:none;border-radius:8px;cursor:pointer;}
.accept-btn{background:green;} .reject-btn{background:red;}
.bottom-nav{position:fixed;bottom:0;width:100%;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 -2px 10px rgba(0,0,0,0.1);}
.bottom-nav div{text-align:center;font-size:14px;color:#ff4fa5;font-weight:bold;display:flex;flex-direction:column;gap:3px;}
.icon{font-size:20px;}
</style>
</head>
<body>

<div class="topbar">
<span onclick="openMenu()">‚ò∞</span>
Dashboard
<span onclick="logout()">‚èª</span>
</div>

<div id="menu">
<a class="closebtn" onclick="closeMenu()">‚úñ</a>
<a href="profile.html">My Profile</a>
<a href="wallet.html">Wallet</a>
<a href="terms.html">Terms & Conditions</a>
<a href="privacy.html">Privacy Policy</a>
<a href="adminhelp.html">Help</a>
<a onclick="logout()">Logout</a>
</div>

<div id="userList" class="scroll-list"></div>

<div class="bottom-nav">
<div onclick="location.href='profile.html'"><span class="icon">üë§</span>Profile</div>
<div onclick="loadUsers()"><span class="icon">‚ù§Ô∏è</span>Profiles</div>
<div onclick="location.href='chat.html'"><span class="icon">üí¨</span>Chat</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* Menu */
function openMenu(){ document.getElementById("menu").style.width="250px"; }
function closeMenu(){ document.getElementById("menu").style.width="0"; }
function logout(){ auth.signOut().then(()=>location.href="login.html"); }

let currentUser=null;

/* Load Users */
auth.onAuthStateChanged(async user=>{
    if(!user){ location.href="login.html"; return; }
    currentUser=user;
    loadUsers();
    loadRequests();
});

/* Load opposite gender users */
async function loadUsers(){
    let listDiv=document.getElementById("userList");
    listDiv.innerHTML="";

    let myDoc=await db.collection("users").doc(currentUser.uid).get();
    let myGender=myDoc.exists?myDoc.data().gender:"Male";
    let opposite=myGender.toLowerCase()==="male"?"Female":"Male";

    let q=await db.collection("users").where("gender","==",opposite).get();

    q.forEach(doc=>{
        let u=doc.data();
        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`<img src="${u.photo||'https://via.placeholder.com/300'}">
        <div class="details">
        <b>${u.name} ${u.surname}</b> | Age:${u.age||"-"}<br>
        Gender: ${u.gender||"-"}<br>
        <button class="like-btn" onclick="sendLike('${doc.id}')">üíú Like</button>
        <button class="chat-btn" onclick="sendRequest('${doc.id}')">Chat Request</button>
        <button class="view-btn" onclick="viewProfile('${doc.id}')">View Profile</button>
        </div>`;
        listDiv.appendChild(card);
    });
}

/* Like / Chat logic */
async function sendLike(uid){
    await db.collection("likes").doc(uid+"_"+currentUser.uid).set({
        from:currentUser.uid,
        to:uid,
        createdAt:Date.now()
    });
    alert("Liked successfully!");
}

async function sendRequest(uid){
    await db.collection("requests").doc(uid+"_"+currentUser.uid).set({
        from:currentUser.uid,
        to:uid,
        status:"pending",
        createdAt:Date.now()
    });
    alert("Request sent!");
}

function viewProfile(uid){
    location.href="profile-view.html?id="+uid;
}

/* Load requests sent to current user */
async function loadRequests(){
    let reqDiv=document.createElement("div");
    reqDiv.style.padding="10px";
    reqDiv.innerHTML="<h3>Incoming Chat Requests</h3>";
    document.body.insertBefore(reqDiv,document.getElementById("userList"));

    let q=await db.collection("requests").where("to","==",currentUser.uid).get();
    q.forEach(doc=>{
        let r=doc.data();
        let row=document.createElement("div");
        row.className="card";
        row.innerHTML=`<div class="details">
        From: ${r.from}<br>
        Status: ${r.status}<br>
        <button class="accept-btn" onclick="respondRequest('${doc.id}',true)">Accept</button>
        <button class="reject-btn" onclick="respondRequest('${doc.id}',false)">Reject</button>
        </div>`;
        reqDiv.appendChild(row);
    });
}

async function respondRequest(id,accept){
    let status=accept?"accepted":"rejected";
    await db.collection("requests").doc(id).update({status});
    alert("Request "+status);
    loadRequests();
}
</script>
</body>
</html>
