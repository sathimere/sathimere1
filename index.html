<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background: #ffe4f0; margin: 0; padding: 0; }
.header { background: #ff1493; padding: 15px; color: white; text-align: center; font-size: 22px; font-weight: bold; position: fixed; top: 0; width: 100%; }
.menu-btn { position: absolute; left: 15px; top: 14px; font-size: 25px; color: white; cursor: pointer; }
.logout-btn { position: absolute; right: 15px; top: 10px; background: white; color: #ff1493; border: 2px solid #ff1493; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
#menu { width: 0; height: 100%; background: white; position: fixed; top: 0; left: 0; overflow: hidden; transition: 0.3s; z-index: 20; padding-top: 60px; box-shadow: 4px 0 12px rgba(0,0,0,0.3); }
#menu a { display: block; padding: 15px 25px; font-size: 18px; text-decoration: none; color: #444; }
#menu a:hover { background: #ffe1f1; }
.close-menu { position: absolute; top: 12px; right: 15px; font-size: 28px; cursor: pointer; }
.container { padding: 80px 15px 80px; }
.user-card { background: white; margin-bottom: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 0 10px #ffc0d9; display: flex; align-items: center; }
.user-card img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 3px solid #ff1493; margin-right: 15px; }
.name { font-weight: bold; color: #ff1493; }
.btn { background: #ff1493; color: white; border: none; border-radius: 8px; margin-top: 5px; padding: 7px 12px; cursor: pointer; }
.btn-disabled { background: gray; }
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; border-top: 1px solid #ddd; padding: 8px 0; }
.nav-item { text-align: center; color: #ff1493; font-weight: bold; }
.nav-item span { font-size: 26px; display: block; }
</style>
</head>

<body>

<div class="header">
    <span class="menu-btn" onclick="openMenu()">‚ò∞</span>
    Sathi Mere
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div id="menu">
    <span class="close-menu" onclick="closeMenu()">‚úñ</span>
    <a href="profile.html">My Profile</a>
    <a href="wallet.html">Wallet</a>
    <a href="help.html">Help & Support</a>
    <a href="privacy.html">Privacy Policy</a>
    <a onclick="logout()">Logout</a>
</div>

<div class="container" id="userList">Loading...</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="location.href='like.html'"><span>üíú</span> Like</div>
    <div class="nav-item" onclick="location.href='chat.html'"><span>‚úâÔ∏è</span> Chat</div>
    <div class="nav-item" onclick="location.href='profile.html'"><span>üë§</span> Profile</div>
</div>

<script>
function openMenu(){ menu.style.width = "260px"; }
function closeMenu(){ menu.style.width = "0"; }

let CURRENT_USER = null;

auth.onAuthStateChanged(async user => {
    if(!user) return window.location="login.html";
    CURRENT_USER = user;
    loadUsers(user.uid);
    listenIncomingRequests(user.uid);
});

// Load users of opposite gender
async function loadUsers(myId){
    const list = document.getElementById("userList");
    list.innerHTML = "Loading...";

    let meDoc = await db.collection("users").doc(myId).get();
    let myGender = meDoc.data().gender;
    let opposite = myGender === "Male" ? "Female" : "Male";

    db.collection("users").where("gender","==",opposite)
      .onSnapshot(snap=>{
        list.innerHTML="";
        snap.forEach(doc=>{
            const u = doc.data();
            const uid = doc.id;

            let card = document.createElement("div");
            card.className="user-card";
            card.innerHTML = `
                <img src="${u.photo || 'https://i.imgur.com/6VBx3io.png'}">
                <div style="flex:1">
                    <div class="name">${u.name} ${u.surname}</div>
                    <div style="color:gray">${u.gender}</div>
                    <button class="btn" onclick="sendLike('${uid}')">üíú Like</button>
                    <button class="btn" onclick="viewProfile('${uid}')">üëÄ View Profile</button>
                    <button id="btn_${uid}" class="btn">‚úâ Chat Request</button>
                </div>
            `;
            list.appendChild(card);

            checkStatus(myId, uid);
            document.getElementById("btn_" + uid).onclick = ()=> sendRequest(myId, uid);
        });
    });
}

async function sendLike(uid){
    await db.collection("likes").add({
        from: CURRENT_USER.uid,
        to: uid,
        time: Date.now()
    });
    alert("Liked!");
}

function viewProfile(uid){
    window.location="view-profile.html?id="+uid;
}

// Check request status
async function checkStatus(myId, otherId){
    let btn = document.getElementById("btn_" + otherId);
    const doc1 = await db.collection("requests").doc(myId+"_"+otherId).get();
    const doc2 = await db.collection("requests").doc(otherId+"_"+myId).get();

    if(doc1.exists && doc1.data().status==="pending"){
        btn.innerText="Request Sent";
        btn.disabled=true;
        btn.classList.add("btn-disabled");
    }

    if(doc1.exists && doc1.data().status==="accepted"){
        btn.innerText="Chat Now";
        btn.onclick = ()=> window.location="chat-room.html?id="+myId+"_"+otherId;
    }

    if(doc2.exists && doc2.data().status==="pending"){
        btn.innerText="Incoming Request";
        btn.disabled=true;
        btn.classList.add("btn-disabled");
    }

    if(doc2.exists && doc2.data().status==="accepted"){
        btn.innerText="Chat Now";
        btn.onclick = ()=> window.location="chat-room.html?id="+myId+"_"+otherId;
    }
}

// Send request
async function sendRequest(myId, toId){
    const meDoc = await db.collection("users").doc(myId).get();
    const myGender = meDoc.data().gender;
    const wallet = meDoc.data().wallet || 0;

    // Male pays Rs10
    if(myGender==="Male" && wallet<10){
        alert("Insufficient balance! Rs 10 required.");
        return;
    }
    if(myGender==="Male"){
        await db.collection("users").doc(myId).update({wallet: wallet-10});
    }

    await db.collection("requests").doc(myId+"_"+toId).set({
        from: myId,
        to: toId,
        status:"pending",
        timestamp: Date.now()
    });

    alert("Chat request sent! Rs 10 deducted if male.");
    checkStatus(myId,toId);
}

// Listen incoming requests for both genders
function listenIncomingRequests(uid){
    db.collection("requests").where("to","==",uid)
      .onSnapshot(snap=>{
        snap.docChanges().forEach(change=>{
            const data = change.doc.data();
            const btn = document.getElementById("btn_" + data.from);
            if(change.type==="added"){
                if(btn) { btn.innerText="Incoming Request"; btn.disabled=true; btn.classList.add("btn-disabled"); }
            }
            if(change.type==="modified" && data.status==="accepted"){
                if(btn) { btn.innerText="Chat Now"; btn.disabled=false; btn.onclick = ()=> window.location="chat-room.html?id="+data.from+"_"+data.to; }
            }
            if(change.type==="removed"){
                // Refund Rs10 if male sender
                db.collection("users").doc(data.from).get().then(doc=>{
                    if(doc.data().gender==="Male"){
                        const wallet = doc.data().wallet || 0;
                        db.collection("users").doc(data.from).update({wallet: wallet+10});
                    }
                });
                if(btn) { btn.innerText="‚úâ Chat Request"; btn.disabled=false; btn.classList.remove("btn-disabled"); }
            }
        });
      });
}

function logout(){
    auth.signOut().then(()=> window.location="login.html");
}
</script>

</body>
</html>
