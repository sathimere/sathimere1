<!DOCTYPE html>
<html>
<head>
<title>Chat Request System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
    font-family: Arial;
    background: #f7f7f7;
    padding: 20px;
}

.card {
    background: #fff;
    padding: 20px;
    width: 94%;
    margin: auto;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.btn {
    background: #ff0066;
    padding: 12px;
    width: 100%;
    color: #fff;
    border: none;
    border-radius: 8px;
    margin-top: 15px;
    font-size: 17px;
}
</style>
</head>

<body>

<div class="card">
    <h2>Send Chat Request</h2>

    <input id="myId" placeholder="Your UID" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;">
    <br><br>
    <input id="toId" placeholder="Other Person UID" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;">

    <button class="btn" onclick="sendRequest()">Send Request</button>

    <p id="status" style="margin-top:15px;font-size:16px;"></p>
</div>

<script>
// ---------------------------
// üî• Firebase Config
// ---------------------------
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


// ---------------------------
// ‚≠ê SEND REQUEST FUNCTION
// ---------------------------
async function sendRequest() {

    let myId = document.getElementById("myId").value;
    let toId = document.getElementById("toId").value;

    if (!myId || !toId) {
        alert("Please enter both IDs");
        return;
    }

    let me = await db.collection("users").doc(myId).get();
    if (!me.exists) {
        alert("Your user not found");
        return;
    }

    let myGender = me.data().gender;


    // -----------------------------------------
    // üë© FEMALE ‚Üí FREE REQUEST
    // -----------------------------------------
    if (myGender === "Female") {

        await db.collection("chatRequests")
            .doc(myId + "_" + toId)
            .set({
                from: myId,
                to: toId,
                status: "pending",
                timestamp: Date.now(),
                paidBy: "Male"
            });

        document.getElementById("status").innerHTML =
            "Request Sent ‚úî (FREE for Female)";

        return;
    }


    // -----------------------------------------
    // üë® MALE ‚Üí ‚Çπ10 DEDUCT
    // -----------------------------------------
    let wallet = await db.collection("wallet").doc(myId).get();
    let balance = wallet.exists ? wallet.data().balance : 0;

    if (balance < 10) {
        alert("Not enough balance! Add money.");
        return;
    }

    // Deduct 10
    await db.collection("wallet").doc(myId).update({
        balance: balance - 10
    });

    // Create request
    await db.collection("chatRequests")
        .doc(myId + "_" + toId)
        .set({
            from: myId,
            to: toId,
            status: "pending",
            timestamp: Date.now(),
            paidBy: "Male"
        });

    // Save History
    await db.collection("history").add({
        uid: myId,
        amount: -10,
        type: "Chat Request",
        time: new Date()
    });

    document.getElementById("status").innerHTML =
        "Request Sent ‚úî (‚Çπ10 deducted from Wallet)";
}


// --------------------------------
// ‚úî Auto-check request status
// --------------------------------
function checkStatus(myId, toId) {
    db.collection("chatRequests")
        .doc(myId + "_" + toId)
        .onSnapshot(doc => {
            if (doc.exists) {
                document.getElementById("status").innerHTML =
                    "Status: " + doc.data().status;
            }
        });
}
</script>

</body>
</html>
