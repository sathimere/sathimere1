<!DOCTYPE html>
<html>
<head>
  <title>Wallet Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; padding:20px; }
    .box{
      max-width:400px; 
      margin:auto; 
      padding:20px; 
      border:1px solid #ddd; 
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
    }
    input,button{
      width:100%; 
      padding:10px; 
      margin:10px 0; 
      font-size:16px;
      border-radius:5px;
    }
    button{
      background:#4CAF50; 
      color:#fff; 
      border:none;
      cursor:pointer;
    }
    button:hover{
      background:#45a049;
    }
    #balBox{
      background:#f1f1f1;
      padding:10px;
      margin-bottom:15px;
      border-radius:5px;
      text-align:center;
      font-size:18px;
      font-weight:bold;
    }
  </style>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

</head>
<body>

<div class="box">

  <div id="balBox">Balance: ₹0</div>

  <h2>Add Money to Wallet</h2>

  <input type="number" id="amount" placeholder="Enter Amount (₹)" />

  <button onclick="addMoney()">Add Money</button>

  <p id="msg" style="color:red;"></p>
</div>

<script>

  /* ------------------------------------
      CONFIG
  ------------------------------------*/

  const BACKEND = "https://sathimere-backend.onrender.com";
  const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";

  const uid = "user_001"; // अपनी login UID lagana

  /* ------------------------------------
      FIREBASE INIT
  ------------------------------------*/

  const firebaseConfig = {
    apiKey: "xxxx",
    authDomain: "xxxx",
    projectId: "xxxx",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();


  /* ------------------------------------
      FETCH CURRENT BALANCE
  ------------------------------------*/

  async function loadBalance() {
    try {
      let doc = await db.collection("wallet").doc(uid).get();
      let bal = doc.exists ? doc.data().balance : 0;

      document.getElementById("balBox").innerText = "Balance: ₹" + bal;
    } catch (e) {
      console.log("Balance error:", e);
    }
  }

  loadBalance();


  /* ------------------------------------
      ADD MONEY
  ------------------------------------*/

  async function addMoney() {
    let amount = Number(document.getElementById("amount").value);

    if (!amount || amount < 10) {
      document.getElementById("msg").innerText = "Minimum ₹10 required.";
      return;
    }

    document.getElementById("msg").innerText = "Creating order...";

    try {

      /* ---- 1) Create Razorpay Order ---- */
      let orderRes = await fetch(`${BACKEND}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, uid })
      });

      let order = await orderRes.json();

      if (!order.id) {
        document.getElementById("msg").innerText = "Order creation failed.";
        return;
      }

      /* ---- 2) Start Razorpay Checkout ---- */
      var options = {
        "key": RAZORPAY_KEY,
        "amount": order.amount,
        "currency": "INR",
        "name": "Wallet Recharge",
        "description": "Add Money to Wallet",
        "order_id": order.id,

        "handler": async function (response) {

          document.getElementById("msg").innerText = "Verifying payment...";

          /* ---- 3) Backend Verification ---- */
          let verifyRes = await fetch(`${BACKEND}/verify-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid,
              amount,
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id
            })
          });

          let verify = await verifyRes.json();

          if (verify.status === "success") {

            /* ---- 4) Update Firebase Wallet ---- */
            await db.collection("wallet").doc(uid).set(
              { balance: firebase.firestore.FieldValue.increment(amount) },
              { merge: true }
            );

            alert("Payment Successful! Wallet Updated.");

            document.getElementById("amount").value = "";
            document.getElementById("msg").innerText = "";

            loadBalance();

          } else {
            document.getElementById("msg").innerText = "Payment verification failed.";
          }
        },

        "theme": { "color": "#3399cc" }
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (e) {
      console.log("ERROR:", e);
      document.getElementById("msg").innerText = "Something went wrong.";
    }
  }

</script>

</body>
  </html>
