<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wallet</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body{
      font-family: Arial;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }
    .container{
      width: 90%;
      margin: auto;
      padding: 20px;
      background: white;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }
    input{
      padding: 10px;
      width: 90%;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 17px;
    }
    button{
      padding: 10px 20px;
      background: #ff4da6;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 15px;
    }
    .history-box{
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Your Wallet Balance: ₹<span id="balance">0</span></h2>

  <input type="number" id="amount" placeholder="Enter amount to add">
  <button onclick="addMoney()">Add Money</button>

  <h3>Transaction History</h3>
  <div id="history" class="history-box">Loading...</div>
</div>

<script>
  // ---------------- FIREBASE CONFIG ----------------
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_FIREBASE_APP_ID"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth();
  const db = firebase.getDatabase();

  const BACKEND_URL = "https://your-backend.onrender.com";

  // ------------ LOAD WALLET BALANCE --------------
  auth.onAuthStateChanged((user)=>{
    if(!user){
      alert("Login required");
      return;
    }
    loadBalance();
    loadHistory();
  });

  function loadBalance(){
    const uid = auth.currentUser.uid;
    const balRef = firebase.ref(db, "wallet/" + uid + "/balance");
    firebase.onValue(balRef, (snap)=>{
      document.getElementById("balance").innerText = snap.val() || 0;
    });
  }

  function loadHistory(){
    const uid = auth.currentUser.uid;
    const hisRef = firebase.ref(db, "wallet/" + uid + "/history");
    firebase.onValue(hisRef, (snap)=>{
      let html = "";
      snap.forEach((child)=>{
        let data = child.val();
        html += `<p>₹${data.amount} - ${data.type} - ${data.date}</p>`;
      });
      document.getElementById("history").innerHTML = html || "No history found";
    });
  }

  // ---------------- ADD MONEY (FINAL FIXED) ----------------
  async function addMoney(){
    let amount = document.getElementById("amount").value;

    // FIX → convert & validate
    amount = parseInt(amount);
    if(isNaN(amount) || amount < 10){
      alert("Enter valid amount (Minimum ₹10)");
      return;
    }

    const uid = auth.currentUser.uid;

    // create order
    const orderRes = await fetch(BACKEND_URL + "/create-order", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ amount, uid })
    });

    const orderData = await orderRes.json();

    if(orderData.error){
      alert("Order creation failed!");
      return;
    }

    var options = {
      "key": "rzp_live_S0WmjPxxVh7JKJ",
      "amount": orderData.amount,
      "currency": "INR",
      "name": "SathiMere Wallet",
      "description": "Adding Money",
      "order_id": orderData.id,
      "handler": async function(response){
        await fetch(BACKEND_URL + "/verify-payment", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            payment_id: response.razorpay_payment_id,
            order_id: response.razorpay_order_id,
            uid,
            amount
          })
        });

        alert("₹" + amount + " added successfully!");
        loadHistory();
      },
      "theme": { "color": "#ff4da6" }
    };

    var rzp = new Razorpay(options);
    rzp.open();
  }
</script>

</body>
  </html>
