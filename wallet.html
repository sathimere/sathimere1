<!DOCTYPE html>
<html>
<head>
  <title>Wallet Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; padding:20px; }
    .box{
      max-width:400px; 
      margin:auto; 
      padding:20px; 
      border:1px solid #ddd; 
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
    }
    input,button{
      width:100%; 
      padding:10px; 
      margin:10px 0; 
      font-size:16px;
      border-radius:5px;
    }
    button{
      background:#4CAF50; 
      color:#fff; 
      border:none;
      cursor:pointer;
    }
    button:hover{
      background:#45a049;
    }
  </style>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<div class="box">
  <h2>Add Money to Wallet</h2>

  <input type="number" id="amount" placeholder="Enter Amount (₹)" />

  <button onclick="addMoney()">Add Money</button>

  <p id="msg" style="color:red;"></p>
</div>

<script>

  const BACKEND = "https://sathimere-backend.onrender.com";
  const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";

  const uid = "user_001";  // Replace with real logged-in user's UID

  async function addMoney() {
    let amount = document.getElementById("amount").value;

    if (!amount || amount < 10) {
      document.getElementById("msg").innerText = "Minimum ₹10 required.";
      return;
    }

    document.getElementById("msg").innerText = "Creating order...";

    try {

      // 1️⃣ Send request to backend to create order
      let orderRes = await fetch(`${BACKEND}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: Number(amount), uid })
      });

      let order = await orderRes.json();

      if (!order.id) {
        document.getElementById("msg").innerText = "Order creation failed.";
        return;
      }

      // 2️⃣ Razorpay payment popup
      var options = {
        "key": RAZORPAY_KEY,
        "amount": order.amount,
        "currency": "INR",
        "name": "Wallet Recharge",
        "description": "Add Money to Wallet",
        "order_id": order.id,

        "handler": async function (response) {

          document.getElementById("msg").innerText = "Verifying payment...";

          // 3️⃣ Verify on backend
          let verifyRes = await fetch(`${BACKEND}/verify-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid,
              amount: Number(amount),
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id
            })
          });

          let verify = await verifyRes.json();

          if (verify.status === "success") {
            alert("Payment Successful! Wallet Updated.");
            document.getElementById("amount").value = "";
            document.getElementById("msg").innerText = "";
          } else {
            document.getElementById("msg").innerText = "Payment verification failed.";
          }
        },

        "theme": { "color": "#3399cc" }
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (e) {
      console.log(e);
      document.getElementById("msg").innerText = "Something went wrong.";
    }
  }

</script>

</body>
</html>
