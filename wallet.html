<!DOCTYPE html>
<html>
<head>
<title>Wallet</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>

<body>

<h2>Your Wallet</h2>
<h1 id="balance">₹0</h1>

<input id="amount" type="number" placeholder="Enter Amount">
<button onclick="addMoney()">Add Money</button>

<p id="msg"></p>

<script>

const BACKEND = "https://sathimere-backend.onrender.com";
const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";

const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid;

// Load wallet after login
auth.onAuthStateChanged(async (user) => {
  if (!user) return window.location.href = "login.html";

  uid = user.uid;

  const ref = db.collection("wallets").doc(uid);

  ref.onSnapshot(snap => {
    if (snap.exists) {
      document.getElementById("balance").innerText = "₹" + snap.data().balance;
    }
  });
});

async function addMoney() {
  
  let amount = Number(document.getElementById("amount").value);
  if (amount < 1) return alert("Minimum ₹1");

  document.getElementById("msg").innerText = "Creating order...";

  // Create order
  let order = await fetch(BACKEND + "/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount })
  }).then(r => r.json());

  if (!order.id) {
    document.getElementById("msg").innerText = "Order failed";
    return;
  }

  // Razorpay Checkout
  var options = {
    key: RAZORPAY_KEY,
    amount: order.amount,
    currency: "INR",
    order_id: order.id,

    handler: async (resp) => {
      document.getElementById("msg").innerText = "Verifying...";

      let verify = await fetch(BACKEND + "/verify-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          payment_id: resp.razorpay_payment_id,
          order_id: resp.razorpay_order_id
        })
      }).then(r => r.json());

      if (verify.status === "success") {
        
        const ref = db.collection("wallets").doc(uid);
        let doc = await ref.get();
        let old = doc.data().balance;

        await ref.update({ balance: old + amount });

        document.getElementById("msg").innerText = "";
        alert("Money Added!");
      }
    }
  };

  new Razorpay(options).open();
}

</script>
</body>
</html>
