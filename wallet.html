<!DOCTYPE html>
<html>
<head>
<title>Wallet – SathiMere</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#f7f7f7;
  font-family:Arial;
}
.header{
  background:#ff4da6;
  color:white;
  text-align:center;
  padding:15px;
  font-size:20px;
  font-weight:bold;
}
.box{
  width:90%;
  margin:auto;
  margin-top:20px;
  background:white;
  border-radius:12px;
  padding:15px;
  box-shadow:0 0 6px rgba(0,0,0,0.1);
}
.balance{
  font-size:26px;
  font-weight:bold;
  color:#ff4da6;
}
input{
  width:100%;
  padding:12px;
  border:1px solid #ccc;
  border-radius:10px;
  margin-top:10px;
}
button{
  width:100%;
  padding:12px;
  background:#ff4da6;
  color:white;
  border:none;
  font-size:18px;
  border-radius:10px;
  margin-top:12px;
}
.history-item{
  background:#fff0fa;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}
</style>
</head>
<body>

<div class="header">My Wallet</div>

<div class="box">
  <div class="balance">Balance: ₹ <span id="balance">0</span></div>
  <input id="amount" type="number" placeholder="Enter Amount">
  <button onclick="startPayment()">Add Money</button>
</div>

<div class="box">
  <h3>Transaction History</h3>
  <div id="history"></div>
</div>

<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

auth.signInAnonymously();

// YOUR Razorpay Frontend Key  
const FRONT_KEY = "rzp_live_xxxxxxx";

// Backend URL
const BACKEND = "https://sathimere-backend.onrender.com";

// Load Wallet After Auth
auth.onAuthStateChanged(async () => {
  loadBalance();
  loadHistory();
});

// Load Balance
function loadBalance(){
  let uid = auth.currentUser.uid;

  db.collection("wallet").doc(uid).onSnapshot(doc=>{
    document.getElementById("balance").innerText = 
      doc.exists ? doc.data().balance : 0;
  });
}

// Step 1 → Create Order
async function startPayment(){
  let amount = document.getElementById("amount").value;
  if(amount <= 0) return alert("Enter valid amount");
  
  const res = await fetch(BACKEND + "/create-order", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ amount: amount })
  });

  const order = await res.json();
  openRazorpay(order, amount);
}

// Step 2 → Open Razorpay Popup
function openRazorpay(order, amount){

  var options = {
    "key": FRONT_KEY,
    "amount": order.amount,
    "currency": "INR",
    "name": "SathiMere Wallet",
    "order_id": order.id,

    "handler": function (resp){
        verifyPayment(resp, amount);
    },

    "theme": { "color": "#ff4da6" }
  };

  var rzp1 = new Razorpay(options);
  rzp1.open();
}

// Step 3 → Verify Payment on Backend
async function verifyPayment(resp, amount){

  const check = await fetch(BACKEND + "/verify-payment", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(resp)
  });

  const result = await check.json();

  if(result.success){
    updateWallet(amount, resp.razorpay_payment_id);
  } 
  else {
    alert("Payment Failed (Signature Mismatch)");
  }
}

// Step 4 → Update Wallet + Save History in Firestore
async function updateWallet(amount, payment_id){
  let uid = auth.currentUser.uid;

  let walletRef = db.collection("wallet").doc(uid);

  await db.runTransaction(async t => {
    let doc = await t.get(walletRef);
    let oldBal = doc.exists ? doc.data().balance : 0;
  
    t.set(walletRef, { balance: oldBal + Number(amount) });
  });

  await db.collection("history").add({
    uid: uid,
    amount: Number(amount),
    type: "Add Money",
    payment_id: payment_id,
    time: new Date()
  });

  alert("₹"+amount+" Added Successfully!");
  loadHistory();
}

// Load History
async function loadHistory(){
  let uid = auth.currentUser.uid;

  let snap = await db.collection("history")
    .where("uid","==",uid)
    .orderBy("time","desc")
    .limit(20)
    .get();

  let box = document.getElementById("history");
  box.innerHTML = "";

  snap.forEach(d=>{
    let x = d.data();
    box.innerHTML += `
      <div class="history-item">
        <b>₹${x.amount}</b> – ${x.type}<br>
        <small>${x.time.toDate()}</small>
      </div>
    `;
  });
}
</script>

</body>
</html>
