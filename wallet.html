<!DOCTYPE html>
<html>
<head>
  <title>Wallet Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; padding:20px; }
    .box{
      max-width:400px; 
      margin:auto; 
      padding:20px; 
      border:1px solid #ddd; 
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
    }
    input,button{
      width:100%; 
      padding:10px; 
      margin:10px 0; 
      font-size:16px;
      border-radius:5px;
    }
    button{
      background:#4CAF50; 
      color:#fff; 
      border:none;
      cursor:pointer;
    }
    button:hover{
      background:#45a049;
    }
    #balanceBox {
      font-size:20px;
      font-weight:bold;
      padding:10px;
      background:#f3f3f3;
      border-radius:8px;
      margin-bottom:15px;
      text-align:center;
    }
  </style>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body>

<div class="box">
  
  <!-- ðŸ”¥ WALLET BALANCE DISPLAY -->
  <div id="balanceBox">Wallet: â‚¹0</div>

  <h2>Add Money to Wallet</h2>

  <input type="number" id="amount" placeholder="Enter Amount (â‚¹)" />

  <button onclick="addMoney()">Add Money</button>

  <p id="msg" style="color:red;"></p>
</div>

<script>

  // ðŸ”¥ FIREBASE CONNECTION
  const firebaseConfig = {
    apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
    authDomain: "sathimere-415fa.firebaseapp.com",
    projectId: "sathimere-415fa",
  };

  const appFB = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // UID (real user ka UID yaha aayega)
  const uid = "user_001";

  // ðŸ”¥ REALTIME WALLET BALANCE
  function loadBalance() {
    db.collection("wallet").doc(uid).onSnapshot(doc => {
      if (doc.exists) {
        const bal = doc.data().balance || 0;
        document.getElementById("balanceBox").innerText = "Wallet: â‚¹" + bal;
      } else {
        document.getElementById("balanceBox").innerText = "Wallet: â‚¹0";
      }
    });
  }

  loadBalance();


  // YOUR ORIGINAL CODE (unchanged)
  const BACKEND = "https://sathimere-backend.onrender.com";
  const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";

  async function addMoney() {
    let amount = document.getElementById("amount").value;

    if (!amount || amount < 10) {
      document.getElementById("msg").innerText = "Minimum â‚¹10 required.";
      return;
    }

    document.getElementById("msg").innerText = "Creating order...";

    try {
      let orderRes = await fetch(`${BACKEND}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: Number(amount), uid })
      });

      let order = await orderRes.json();

      if (!order.id) {
        document.getElementById("msg").innerText = "Order creation failed.";
        return;
      }

      var options = {
        "key": RAZORPAY_KEY,
        "amount": order.amount,
        "currency": "INR",
        "name": "Wallet Recharge",
        "description": "Add Money to Wallet",
        "order_id": order.id,

        "handler": async function (response) {
          document.getElementById("msg").innerText = "Verifying payment...";

          let verifyRes = await fetch(`${BACKEND}/verify-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid,
              amount: Number(amount),
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id
            })
          });

          let verify = await verifyRes.json();

          if (verify.status === "success") {
            alert("Payment Successful! Wallet Updated.");
            document.getElementById("amount").value = "";
            document.getElementById("msg").innerText = "";
            loadBalance(); // ðŸ”¥ UPDATE BALANCE AFTER PAYMENT
          } else {
            document.getElementById("msg").innerText = "Payment verification failed.";
          }
        },

        "theme": { "color": "#3399cc" }
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (e) {
      console.log(e);
      document.getElementById("msg").innerText = "Something went wrong.";
    }
  }

</script>

</body>
</html>
