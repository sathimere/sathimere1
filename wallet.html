<!DOCTYPE html>
<html>
<head>
  <title>Wallet Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; padding:20px; background:#f7f7f7; }
    .box{
      max-width:400px; 
      margin:auto; 
      padding:20px; 
      border:1px solid #ddd; 
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      background:#fff;
      margin-bottom:20px;
    }
    input,button{
      width:100%; 
      padding:10px; 
      margin:10px 0; 
      font-size:16px;
      border-radius:5px;
    }
    button{
      background:#4CAF50; 
      color:#fff; 
      border:none;
      cursor:pointer;
    }
    button:hover{
      background:#45a049;
    }
    #balBox{
      background:#f1f1f1;
      padding:10px;
      margin-bottom:15px;
      border-radius:5px;
      text-align:center;
      font-size:18px;
      font-weight:bold;
    }
    .history-item{
      background:#f0f0f0;
      padding:10px;
      border-radius:5px;
      margin-top:8px;
      font-size:14px;
    }
  </style>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

</head>
<body>

<div class="box">

  <div id="balBox">Balance: ₹0</div>

  <h2>Add Money to Wallet</h2>
  <input type="number" id="amount" placeholder="Enter Amount (₹)" />
  <button onclick="addMoney()">Add Money</button>

  <p id="msg" style="color:red;"></p>
</div>

<div class="box">
  <h3>Transaction History</h3>
  <div id="history"></div>
</div>

<script>
  const BACKEND = "https://sathimere-backend.onrender.com";
  const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";

  // Multiple users support → prompt for UID
  const uid = prompt("Enter your User ID") || "user_default";

  /* ---------------------------------------------
      FIREBASE CONFIG 
  ---------------------------------------------*/
  const firebaseConfig = {
    apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
    authDomain: "sathimere-415fa.firebaseapp.com",
    databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sathimere-415fa",
    storageBucket: "sathimere-415fa.firebasestorage.app",
    messagingSenderId: "290492321074",
    appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* ------------------------------------
      FETCH CURRENT BALANCE
  ------------------------------------*/
  async function loadBalance() {
    try {
      let doc = await db.collection("wallet").doc(uid).get();
      let bal = doc.exists ? doc.data().balance : 0;
      document.getElementById("balBox").innerText = "Balance: ₹" + bal;
    } catch (e) {
      console.log("Balance error:", e);
    }
  }

  /* ------------------------------------
      LOAD TRANSACTION HISTORY
  ------------------------------------*/
  async function loadHistory() {
    try {
      let snap = await db.collection("history")
        .where("uid","==",uid)
        .orderBy("time","desc")
        .limit(20)
        .get();

      let box = document.getElementById("history");
      box.innerHTML = "";
      snap.forEach(d=>{
        let x = d.data();
        let date = x.time.toDate();
        box.innerHTML += `<div class="history-item">
          ₹${x.amount} – ${x.type}<br>
          <small>${date.toLocaleString()}</small>
        </div>`;
      });
    } catch(e){
      console.log("History error:", e);
    }
  }

  loadBalance();
  loadHistory();

  /* ------------------------------------
      ADD MONEY
  ------------------------------------*/
  async function addMoney() {
    let amount = Number(document.getElementById("amount").value);

    if (!amount || amount < 1) {
      document.getElementById("msg").innerText = "Minimum ₹1 required.";
      return;
    }

    document.getElementById("msg").innerText = "Creating order...";

    try {
      let orderRes = await fetch(`${BACKEND}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, uid })
      });

      let order = await orderRes.json();

      if (!order.id) {
        document.getElementById("msg").innerText = "Order creation failed.";
        return;
      }

      var options = {
        "key": RAZORPAY_KEY,
        "amount": order.amount,
        "currency": "INR",
        "name": "Wallet Recharge",
        "description": "Add Money to Wallet",
        "order_id": order.id,

        "handler": async function (response) {
          document.getElementById("msg").innerText = "Verifying payment...";

          let verifyRes = await fetch(`${BACKEND}/verify-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid,
              amount,
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id
            })
          });

          let verify = await verifyRes.json();

          if (verify.status === "success") {

            /* -----------------------------------------
                SAVE TO WALLET
            -----------------------------------------*/
            const ref = db.collection("wallet").doc(uid);
            let w = await ref.get();

            if (!w.exists) {
              await ref.set({ balance: amount });
            } else {
              await ref.update({
                balance: (w.data().balance || 0) + amount
              });
            }

            /* -----------------------------------------
                SAVE TRANSACTION HISTORY
            -----------------------------------------*/
            await db.collection("history").add({
              uid: uid,
              amount: amount,
              type: "Add Money",
              payment_id: response.razorpay_payment_id,
              time: new Date()
            });

            alert("Payment Successful! Wallet Updated.");

            document.getElementById("amount").value = "";
            document.getElementById("msg").innerText = "";

            loadBalance();
            loadHistory();

          } else {
            document.getElementById("msg").innerText = "Payment verification failed.";
          }
        },

        "theme": { "color": "#3399cc" }
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (e) {
      console.log("ERROR:", e);
      document.getElementById("msg").innerText = "Something went wrong.";
    }
  }

</script>

</body>
  </html>
