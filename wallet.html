<!DOCTYPE html>
<html>
<head>
<title>Wallet – SathiMere</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#f7f7f7;font-family:Arial;}
.header{background:#ff4da6;color:white;text-align:center;padding:15px;font-size:20px;font-weight:bold;}
.box{width:90%;margin:auto;margin-top:20px;background:white;border-radius:12px;padding:15px;box-shadow:0 0 6px rgba(0,0,0,0.1);}
.balance{font-size:26px;font-weight:bold;color:#ff4da6;}
input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;margin-top:10px;}
button{width:100%;padding:12px;background:#ff4da6;color:white;border:none;font-size:18px;border-radius:10px;margin-top:12px;}
.history-item{background:#fff0fa;padding:10px;border-radius:8px;margin-top:8px;}
</style>
</head>
<body>

<div class="header">My Wallet</div>

<div class="box">
  <div class="balance">Balance: ₹ <span id="balance">0</span></div>
  <input id="amount" type="number" placeholder="Enter Amount">
  <button onclick="addMoney()">Add Money</button>
</div>

<div class="box">
  <h3>Transaction History</h3>
  <div id="history"></div>
</div>

<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously();

// Backend URL
const BACKEND_URL = "https://sathimere-backend.onrender.com";

// Load wallet
auth.onAuthStateChanged(async ()=>{
  const uid = auth.currentUser.uid;

  db.collection("wallet").doc(uid).onSnapshot(doc=>{
    if(doc.exists) document.getElementById("balance").innerText = doc.data().balance || 0;
  });

  loadHistory();
});

async function addMoney(){
  let amount = parseInt(document.getElementById("amount").value);
  if(!amount || amount<=0){ alert("Enter valid amount"); return; }

  const uid = auth.currentUser.uid;

  // Create order from backend
  const orderRes = await fetch(BACKEND_URL+"/create-order", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({amount, uid})
  });
  const orderData = await orderRes.json();

  if(orderData.error){ alert("Order creation failed: "+orderData.error); return; }

  var options = {
    "key": "rzp_live_S0WmjPxxVh7JKJ",
    "amount": orderData.amount,
    "currency": "INR",
    "name": "SathiMere Wallet",
    "description": "Add Money",
    "order_id": orderData.id,
    "handler": async function(response){
      await fetch(BACKEND_URL+"/verify-payment", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          payment_id: response.razorpay_payment_id,
          order_id: response.razorpay_order_id,
          uid,
          amount
        })
      });
      alert("₹"+amount+" added successfully!");
      loadHistory();
    },
    "theme":{"color":"#ff4da6"}
  };

  new Razorpay(options).open();
}

// Load transaction history
async function loadHistory(){
  const uid = auth.currentUser.uid;
  const snap = await db.collection("history").where("uid","==",uid).orderBy("time","desc").limit(20).get();
  const box = document.getElementById("history");
  box.innerHTML = "";
  snap.forEach(d=>{
    const x = d.data();
    box.innerHTML += `<div class="history-item"><b>₹${x.amount}</b> – ${x.type}<br><small>${x.time.toDate()}</small></div>`;
  });
}
</script>
</body>
</html>
