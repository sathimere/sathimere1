<!DOCTYPE html>
<html>
<head>
  <title>Wallet Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; padding:20px; }

    .box{
      max-width:400px;
      margin:auto;
      padding:20px;
      border:1px solid #ddd;
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
    }

    input,button{
      width:100%; padding:10px;
      margin:10px 0; font-size:16px;
      border-radius:5px;
    }

    button{
      background:#4CAF50; color:#fff;
      border:none; cursor:pointer;
    }

    button:hover{ background:#45a049; }

    .balanceBox{
      max-width:400px;
      margin:auto;
      padding:15px;
      font-size:22px;
      background:#e8ffe8;
      border-radius:10px;
      text-align:center;
      margin-bottom:20px;
      border:1px solid #b6ffb6;
    }
  </style>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<!-- ðŸ”µ WALLET BALANCE SHOW -->
<div class="balanceBox">
  Wallet Balance: â‚¹ <span id="walletBalance">0</span>
</div>

<div class="box">
  <h2>Add Money to Wallet</h2>

  <input type="number" id="amount" placeholder="Enter Amount (â‚¹)" />

  <button onclick="addMoney()">Add Money</button>

  <p id="msg" style="color:red;"></p>
</div>


<script>

  // ================================
  // ðŸ”¥ FIREBASE
  // ================================
  const firebaseConfig = {
    apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
    authDomain: "sathimere-415fa.firebaseapp.com",
    projectId: "sathimere-415fa",
    storageBucket: "sathimere-415fa.firebasestorage.app",
    messagingSenderId: "290492321074",
    appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // user ID (replace later)
  const uid = "user_001";

  // Load balance from Firebase
  function loadBalance() {
    db.collection("wallet").doc(uid).onSnapshot(doc=>{
      if (doc.exists) {
        document.getElementById("walletBalance").innerText = doc.data().balance || 0;
      }
    });
  }

  loadBalance(); // Initial load



  // ================================
  // ðŸ”¥ BACKEND + PAYMENT
  // ================================
  const BACKEND = "https://sathimere-backend.onrender.com";
  const RAZORPAY_KEY = "rzp_live_S0WmjPxxVh7JKJ";


  async function addMoney() {
    let amount = document.getElementById("amount").value;

    if (!amount || amount < 10) {
      document.getElementById("msg").innerText = "Minimum â‚¹10 required.";
      return;
    }

    document.getElementById("msg").innerText = "Creating order...";

    try {

      // 1ï¸âƒ£ Create order
      let orderRes = await fetch(`${BACKEND}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: Number(amount), uid })
      });

      let order = await orderRes.json();

      if (!order.id) {
        document.getElementById("msg").innerText = "Order creation failed.";
        return;
      }

      // 2ï¸âƒ£ Open Razorpay popup
      var options = {
        "key": RAZORPAY_KEY,
        "amount": order.amount,
        "currency": "INR",
        "name": "Wallet Recharge",
        "description": "Add Money to Wallet",
        "order_id": order.id,

        "handler": async function (response) {

          document.getElementById("msg").innerText = "Verifying payment...";

          // 3ï¸âƒ£ Verify on backend
          let verifyRes = await fetch(`${BACKEND}/verify-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid,
              amount: Number(amount),
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id
            })
          });

          let verify = await verifyRes.json();

          if (verify.status === "success") {

            // 4ï¸âƒ£ Firebase wallet update
            db.collection("wallet").doc(uid).set({
              balance: firebase.firestore.FieldValue.increment(Number(amount))
            }, { merge: true });

            alert("Payment Successful! â‚¹" + amount + " added.");
            document.getElementById("amount").value = "";
            document.getElementById("msg").innerText = "";

          } else {
            document.getElementById("msg").innerText = "Payment verification failed.";
          }
        },

        "theme": { "color": "#3399cc" }
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (e) {
      console.log(e);
      document.getElementById("msg").innerText = "Something went wrong.";
    }
  }

</script>

</body>
</html>
