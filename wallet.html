<!DOCTYPE html>
<html>
<head>
    <title>Wallet</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
    <h2>Your Balance: ₹<span id="balance">0</span></h2>
    <input id="amount" placeholder="Enter Amount" />
    <button onclick="addMoney()">Add Money</button>

<script>
//--------------------------------------------
// FIREBASE CONFIG
//--------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};
firebase.initializeApp(firebaseConfig);

// TEMP USER UID
let uid = localStorage.getItem("uid");
if (!uid) {
    uid = "user" + Date.now();
    localStorage.setItem("uid", uid);
}

//--------------------------------------------
// WALLET REFERENCE
//--------------------------------------------
const walletRef = firebase.database().ref("wallets/" + uid);

// CHECK IF WALLET EXISTS
walletRef.once("value", snap => {
    if (!snap.exists()) {
        walletRef.set({
            balance: 0,
            lastUpdate: Date.now()
        });
    }
});

// REALTIME BALANCE UPDATE
walletRef.on("value", snap => {
    const data = snap.val();
    if (data && data.balance != null) {
        document.getElementById("balance").innerText = data.balance;
    }
});

//--------------------------------------------
// ADD MONEY FUNCTION
//--------------------------------------------
async function addMoney() {
    const amount = Number(document.getElementById("amount").value);
    if (!amount || amount <= 0) return alert("Enter valid amount");

    // 1️⃣ CREATE ORDER ON SERVER
    const order = await fetch("https://sathimere-backend.onrender.com/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, uid })
    }).then(res => res.json());

    // 2️⃣ OPEN RAZORPAY CHECKOUT
    const options = {
        key: "rzp_live_S0WmjPxxVh7JKJ", // Razorpay live key
        amount: order.amount,
        currency: "INR",
        name: "SathiMere Wallet",
        order_id: order.id,
        handler: async function(response) {

            // 3️⃣ VERIFY PAYMENT ON SERVER
            const verify = await fetch("https://sathimere-backend.onrender.com/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    order_id: order.id,
                    payment_id: response.razorpay_payment_id,
                    signature: response.razorpay_signature,
                    uid,
                    amount
                })
            }).then(res => res.json());

            if (verify.status === "success") {
                alert("Payment Successful! Wallet Updated.");
                // Firebase realtime listener automatically updates balance
            } else {
                alert("Payment verification failed!");
            }
        }
    };

    const rzp = new Razorpay(options);
    rzp.open();
}
</script>
</body>
</html>
