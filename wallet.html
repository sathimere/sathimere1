<!DOCTYPE html>
<html>
<head>
<title>Wallet â€“ SathiMere</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#f7f7f7;
  font-family:Arial;
}
.header{
  background:#ff4da6;
  color:white;
  text-align:center;
  padding:15px;
  font-size:20px;
  font-weight:bold;
}
.box{
  width:90%;
  margin:auto;
  margin-top:20px;
  background:white;
  border-radius:12px;
  padding:15px;
  box-shadow:0 0 6px rgba(0,0,0,0.1);
}
.balance{
  font-size:26px;
  font-weight:bold;
  color:#ff4da6;
}
input{
  width:100%;
  padding:12px;
  border:1px solid #ccc;
  border-radius:10px;
  margin-top:10px;
}
button{
  width:100%;
  padding:12px;
  background:#ff4da6;
  color:white;
  border:none;
  font-size:18px;
  border-radius:10px;
  margin-top:12px;
}
.history-item{
  background:#fff0fa;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}
</style>
</head>
<body>

<div class="header">My Wallet</div>

<div class="box">
  <div class="balance">Balance: â‚¹ <span id="balance">0</span></div>

  <input id="amount" type="number" placeholder="Enter Amount">
  <button onclick="addMoney()">Add Money</button>
</div>

<div class="box">
  <h3>Transaction History</h3>
  <div id="history"></div>
</div>

<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ðŸ”¹ Backend URL
const BACKEND_URL = "https://sathimere-backend.onrender.com";

// Temporary/demo login
auth.signInAnonymously();

// Load balance & history
auth.onAuthStateChanged(async () => {
  const uid = auth.currentUser.uid;
  db.collection("wallet").doc(uid).onSnapshot(doc => {
    if(doc.exists){
      document.getElementById("balance").innerText = doc.data().balance || 0;
    }
  });
  loadHistory();
});

// Add Money
async function addMoney(){
  let amount = parseInt(document.getElementById("amount").value);
  if(!amount || amount <= 0) return alert("Enter valid amount");

  try {
    // 1ï¸âƒ£ Create Razorpay order via backend
    const orderRes = await fetch(BACKEND_URL + "/create-order", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ amount })
    });
    const orderData = await orderRes.json();

    // 2ï¸âƒ£ Open Razorpay
    const rzp = new Razorpay({
      key: orderData.key_id || orderData.key, // fallback
      amount: orderData.amount,
      currency: orderData.currency,
      order_id: orderData.id,
      name: "SathiMere Wallet",
      description: "Add Money",
      theme:{ color:"#ff4da6" },
      handler: async function (response){
        // 3ï¸âƒ£ Verify payment via backend
        const verifyRes = await fetch(BACKEND_URL + "/verify", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(response)
        });
        const verifyData = await verifyRes.json();

        if(verifyData.success){
          // 4ï¸âƒ£ Update Firebase wallet + history
          const uid = auth.currentUser.uid;
          const ref = db.collection("wallet").doc(uid);
          await db.runTransaction(async t => {
            const doc = await t.get(ref);
            const oldBalance = doc.exists ? doc.data().balance : 0;
            t.set(ref, { balance: oldBalance + amount });
          });
          await db.collection("history").add({
            uid: uid,
            amount: amount,
            type: "Add Money",
            payment_id: response.razorpay_payment_id,
            time: new Date()
          });
          alert("â‚¹"+amount+" added successfully!");
          loadHistory();
        } else {
          alert("Payment verification failed!");
        }
      }
    });
    rzp.open();

  } catch (err) {
    console.error(err);
    alert("Payment failed. Try again!");
  }
}

// Load history
async function loadHistory(){
  const uid = auth.currentUser.uid;
  const snap = await db.collection("history")
    .where("uid","==",uid)
    .orderBy("time","desc")
    .limit(20)
    .get();
  const box = document.getElementById("history");
  box.innerHTML = "";
  snap.forEach(d=>{
    const x = d.data();
    box.innerHTML += `
      <div class="history-item">
        <b>â‚¹${x.amount}</b> â€“ ${x.type}<br>
        <small>${x.time.toDate()}</small>
      </div>
    `;
  });
}
</script>

</body>
</html>
