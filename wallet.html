<!DOCTYPE html>
<html>
<head>
    <title>Wallet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Razorpay -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        input { width: 100%; padding: 12px; margin-top: 10px; }
        button { width: 100%; padding: 12px; background: #000; color: #fff; margin-top: 10px; }
        #balanceBox { padding: 15px; background: #f1f1f1; margin-bottom: 15px; font-size: 18px; }
    </style>
</head>

<body>

    <h2>My Wallet</h2>

    <div id="balanceBox">Balance: ₹0</div>

    <input type="number" id="amount" placeholder="Enter Amount">
    <button id="addBtn">Add Money</button>

    <script>

        /* ------------------------------------
              FIREBASE CONFIG
        ------------------------------------ */
        const firebaseConfig = {
            apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
            authDomain: "sathimere-415fa.firebaseapp.com",
            projectId: "sathimere-415fa",
            storageBucket: "sathimere-415fa.appspot.com",
            messagingSenderId: "290492321074",
            appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* ------------------------------------
              UID FIXED (wallet/user_001)
        ------------------------------------ */
        const uid = "user_001"; // FIXED — Firebase me yahi node banega


        /* ------------------------------------
              LOAD CURRENT BALANCE
        ------------------------------------ */
        function loadBalance() {
            db.collection("wallet").doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    document.getElementById("balanceBox").innerHTML =
                        "Balance: ₹" + doc.data().balance;
                } else {
                    document.getElementById("balanceBox").innerHTML = "Balance: ₹0";
                }
            });
        }

        loadBalance();


        /* ------------------------------------
              ADD MONEY
        ------------------------------------ */
        document.getElementById("addBtn").addEventListener("click", async () => {

            let amount = Number(document.getElementById("amount").value);

            if (!amount || amount < 10) {
                alert("Minimum ₹10 required");
                return;
            }

            // CREATE ORDER
            const orderRes = await fetch("https://sathimere-backend.onrender.com/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount })
            });

            const order = await orderRes.json();

            if (!order.id) {
                alert("Order creation failed");
                return;
            }

            // OPEN RAZORPAY CHECKOUT
            let options = {
                key: "rzp_live_S0WmjPxxVh7JKJ",
                amount: order.amount,
                currency: "INR",
                order_id: order.id,

                handler: async function () {

                    // CALL BACKEND VERIFY (simplified)
                    await fetch("https://sathimere-backend.onrender.com/verify-payment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            uid: uid,
                            amount: amount
                        })
                    });

                    // UPDATE FIREBASE WALLET
                    const ref = db.collection("wallet").doc(uid);
                    let doc = await ref.get();

                    if (!doc.exists) {
                        await ref.set({ balance: amount });
                    } else {
                        await ref.update({
                            balance: (doc.data().balance || 0) + amount
                        });
                    }

                    alert("Balance Added Successfully!");

                    document.getElementById("amount").value = "";
                }
            };

            let rzp = new Razorpay(options);
            rzp.open();

        });

    </script>

</body>
</html>
