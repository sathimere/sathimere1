<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="firebase.js"></script>

<style>
body{
  margin:0;
  font-family: 'Poppins', Arial;
  background:#ffeef7;
}
.header{
  width:100%;
  background:#ff4da6;
  padding:25px 0;
  text-align:center;
  color:white;
  font-size:23px;
  font-weight:bold;
  border-radius:0 0 25px 25px;
}
.container{
  width:92%;
  margin:auto;
  margin-top:20px;
}
.profile-card{
  text-align:center;
  margin-top:-60px;
}
.profile-pic{
  width:140px;
  height:140px;
  border-radius:50%;
  border:5px solid white;
  box-shadow:0 0 10px rgba(0,0,0,0.15);
  object-fit:cover;
}
.change-btn{
  background:#ff4da6;
  color:white;
  border:none;
  padding:10px;
  width:100%;
  border-radius:8px;
  margin-top:8px;
  font-size:15px;
}
.box{
  background:white;
  padding:18px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 0 8px rgba(0,0,0,0.08);
}
input, select, textarea{
  width:100%;
  padding:12px;
  border:1px solid #ccc;
  border-radius:8px;
  margin-top:7px;
  font-size:14px;
}
label{
  font-size:14px;
  color:#222;
  font-weight:600;
}
.row-2{
  display:flex;
  gap:10px;
}
.row-2 > div{
  flex:1;
}
.save-btn{
  background:#ff4da6;
  color:white;
  border:none;
  padding:15px;
  width:100%;
  border-radius:10px;
  margin-top:18px;
  font-size:17px;
  font-weight:bold;
  box-shadow:0 3px 10px rgba(255,77,166,0.3);
}
</style>
</head>

<body>

<div class="header">My Profile</div>

<div class="profile-card">
  <img id="profileImg" class="profile-pic" src="https://i.imgur.com/3G0P4tJ.png">
</div>

<div class="container">

  <input type="file" id="photo" style="display:none">
  <button class="change-btn" onclick="document.getElementById('photo').click()">Change Photo</button>

  <div class="box">

    <label>Surname</label>
    <input id="surname" type="text">

    <label>Name</label>
    <input id="name" type="text">

    <label>Father's Name</label>
    <input id="father" type="text">

    <label>Mother's Name</label>
    <input id="mother" type="text">

    <div class="row-2">
      <div>
        <label>Age</label>
        <input id="age" type="number">
      </div>
      <div>
        <label>Date of Birth</label>
        <input id="dob" type="date">
      </div>
    </div>

    <label>Email</label>
    <input id="email" type="text">

    <label>Mobile</label>
    <input id="mobile" type="text">

    <label>Mobile Visibility</label>
    <select id="mobilePrivacy">
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>

    <label>City</label>
    <input id="city" type="text">

    <label>State</label>
    <input id="state" type="text">

    <label>District</label>
    <input id="district" type="text">

    <label>Caste</label>
    <input id="caste" type="text">

    <label>Address</label>
    <textarea id="address"></textarea>

    <label>Gender</label>
    <select id="gender">
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>

    <label>Choice (Partner Preference)</label>
    <textarea id="choice"></textarea>

    <label>Interest</label>
    <textarea id="interest"></textarea>

    <button class="save-btn" onclick="saveProfile()">Save Profile</button>
  </div>
</div>

<script>
const imgbbKey = "5d029a90e51dd6f7960ae7c3a7ac4200";


/* LOAD USER DATA */
auth.onAuthStateChanged(async (user)=>{
    if(!user){
        window.location="login.html";
        return;
    }
    loadData(user.uid);
});


/* GET DATA SAFELY EVEN IF EMPTY */
async function loadData(uid){
    let doc = await db.collection("users").doc(uid).get();

    if(doc.exists){
        let d = doc.data();

        surname.value = d.surname || "";
        name.value = d.name || "";
        father.value = d.father || "";
        mother.value = d.mother || "";
        age.value = d.age || "";
        dob.value = d.dob || "";
        email.value = d.email || "";
        mobile.value = d.mobile || "";
        mobilePrivacy.value = d.mobilePrivacy || "public";
        city.value = d.city || "";
        state.value = d.state || "";
        district.value = d.district || "";
        caste.value = d.caste || "";
        address.value = d.address || "";
        gender.value = d.gender || "";
        choice.value = d.choice || "";
        interest.value = d.interest || "";

        if(d.photo){
            profileImg.src = d.photo;
        }
    }
}


/* SAVE PROFILE — FIXED (NO CRASH, EVEN IF FIELDS EMPTY) */
async function saveProfile(){

    let user = auth.currentUser;
    if(!user) return;

    let uid = user.uid;

    let file = photo.files[0];
    let photoURL = profileImg.src;

    // If photo is selected
    if(file){
        try {
            let base64 = await toBase64(file);
            let fd = new FormData();
            fd.append("key", imgbbKey);
            fd.append("image", base64.split(",")[1]);

            let res = await fetch("https://api.imgbb.com/1/upload", { method:"POST", body:fd });
            let json = await res.json();
            if(json?.data?.url){
                photoURL = json.data.url;
            }
        } catch(e){
            console.log("Image upload failed:", e);
        }
    }

    // SAVE without any required fields (NO CRASH)
    await db.collection("users").doc(uid).set({
        surname: surname.value || "",
        name: name.value || "",
        father: father.value || "",
        mother: mother.value || "",
        age: age.value || "",
        dob: dob.value || "",
        email: email.value || "",
        mobile: mobile.value || "",
        mobilePrivacy: mobilePrivacy.value || "public",
        city: city.value || "",
        state: state.value || "",
        district: district.value || "",
        caste: caste.value || "",
        address: address.value || "",
        gender: gender.value || "",
        choice: choice.value || "",
        interest: interest.value || "",
        photo: photoURL || "",
        updatedAt: Date.now()
    }, { merge:true });

    alert("Profile Updated Successfully!");
    window.location = "index.html";
}


/* IMAGE → BASE64 */
function toBase64(file){
    return new Promise((resolve,reject)=>{
        let r = new FileReader();
        r.onload = ()=>resolve(r.result);
        r.onerror = err=>reject(err);
        r.readAsDataURL(file);
    });
}
</script>

</body>
</html>
