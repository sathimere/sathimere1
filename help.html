<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Help & Support</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f7fa;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 450px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 10px #0002;
    }
    h2 { text-align: center; margin-bottom: 15px; }
    input, textarea {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
    }
    button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background: #005eff;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
    }
    .reply-box {
        margin-top: 20px;
        background: #e9f3ff;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #005eff;
        display: none;
    }
</style>

</head>
<body>

<div class="container">
    <h2>Help & Support</h2>

    <input type="text" id="subject" placeholder="Enter Subject">
    <textarea id="message" rows="5" placeholder="Describe your issue..."></textarea>
    
    <button onclick="sendHelp()">Submit Request</button>

    <div id="replyBox" class="reply-box">
        <h3>Admin Reply</h3>
        <p id="replyText"></p>
    </div>
</div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
/* ------------------------------------------------- */

// USER MUST BE LOGGED IN â†’ FIREBASE UID USED AS TICKET ID
auth.onAuthStateChanged(user => {
    if (!user) {
        alert("Please login first!");
        return;
    }
    currentUser = user.uid;
    loadReply();
});

/* ---------------- SEND HELP REQUEST ---------------- */
function sendHelp() {
    const subject = document.getElementById("subject").value.trim();
    const message = document.getElementById("message").value.trim();

    if (!subject || !message) {
        alert("Please fill all fields.");
        return;
    }

    db.collection("helpRequests").doc(currentUser).set({
        subject: subject,
        message: message,
        reply: "",
        userId: currentUser,
        timestamp: Date.now()
    })
    .then(() => {
        alert("Request sent successfully!");
    })
    .catch(err => alert("Error: " + err.message));
}

/* ---------------- LIVE ADMIN REPLY LISTENER ---------------- */
function loadReply() {
    db.collection("helpRequests").doc(currentUser)
    .onSnapshot(doc => {
        if (doc.exists && doc.data().reply !== "") {
            document.getElementById("replyText").innerText = doc.data().reply;
            document.getElementById("replyBox").style.display = "block";
        }
    });
}

</script>

</body>
</html>
