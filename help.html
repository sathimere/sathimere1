<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Help & Support</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body{
            font-family: Arial;
            background:#f9f9f9;
            padding:15px;
            margin:0;
        }
        h2{
            text-align:center;
            background:#ff1493;
            padding:12px;
            border-radius:10px;
            color:white;
        }
        .input-box, textarea{
            width:100%;
            padding:12px;
            margin-top:8px;
            border-radius:8px;
            border:1px solid #ccc;
        }
        button{
            width:100%;
            background:#ff1493;
            padding:12px;
            border:none;
            color:white;
            margin-top:10px;
            border-radius:8px;
            font-size:16px;
            cursor:pointer;
        }
        .ticket{
            background:white;
            padding:15px;
            margin-top:15px;
            border-radius:10px;
            box-shadow:0px 0px 5px rgba(0,0,0,0.1);
        }
        .status{
            display:inline-block;
            padding:4px 10px;
            border-radius:6px;
            font-size:12px;
        }
        .pending{ background:orange; color:white; }
        .done{ background:green; color:white; }
        .reply-box{
            margin-top:10px;
            padding:10px;
            border-left:4px solid #ff1493;
            background:#ffe6f2;
            border-radius:8px;
        }
    </style>
</head>
<body>

<h2>Help & Support</h2>

<h3>Submit Your Query</h3>

<input id="name" class="input-box" placeholder="Your Name">
<input id="email" class="input-box" placeholder="Your Email">
<textarea id="message" placeholder="Write your problem..."></textarea>

<button onclick="sendHelp()">Submit</button>

<h3>Your Previous Queries</h3>
<div id="myTickets"></div>

<script>
    /* ---------------- FIREBASE CONNECT ---------------- */
    const firebaseConfig = {
        apiKey: "AIzaSyD2yY-xxxxxxxxxxxxxxxx",
        authDomain: "sathimere-xxxx.firebaseapp.com",
        projectId: "sathimere-xxxx",
        storageBucket: "sathimere-xxxx.appspot.com",
        messagingSenderId: "78xxxxxxx",
        appId: "1:78xxxxxxxx:web:xxxxxxxxxx"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();


    /* ---------------- SEND HELP REQUEST ---------------- */
    function sendHelp() {
        let name = document.getElementById("name").value.trim();
        let email = document.getElementById("email").value.trim();
        let message = document.getElementById("message").value.trim();

        if(!name || !email || !message){
            alert("Please fill all fields!");
            return;
        }

        db.collection("helpRequests").add({
            name,
            email,
            message,
            reply: "",
            status: "pending",
            timestamp: new Date()
        }).then(()=>{
            alert("Message sent! Our team will reply soon.");
            document.getElementById("message").value = "";
        });
    }


    /* ---------------- LOAD USER TICKETS ---------------- */
    function loadMyTickets(){
        let email = localStorage.getItem("userEmail");

        // If user has not typed email yet, wait until user types
        document.getElementById("email").addEventListener("change", function(){
            localStorage.setItem("userEmail", this.value);
            loadMyTickets();
        });

        if(!email) return;

        db.collection("helpRequests")
        .where("email", "==", email)
        .orderBy("timestamp", "desc")
        .onSnapshot(res=>{
            let html = "";
            res.forEach(doc=>{
                let t = doc.data();

                html += `
                    <div class="ticket">
                        <b>Your Message:</b><br>${t.message}<br><br>

                        <span class="status ${t.reply ? 'done':'pending'}">
                            ${t.reply ? 'Replied' : 'Pending'}
                        </span>

                        ${t.reply ? `
                          <div class="reply-box">
                            <b>Admin Reply:</b><br>${t.reply}
                          </div>
                        ` : ""}
                    </div>
                `;
            });

            document.getElementById("myTickets").innerHTML = html;
        });
    }

    loadMyTickets();
</script>

</body>
</html>
