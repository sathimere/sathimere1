<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Sathi Mere</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>

  <style>
    body{
      font-family: Arial;
      background:#ffe4f0;
      padding:15px;
    }

    .topbar{
      background:#ff1493;
      padding:12px;
      color:white;
      font-size:20px;
      text-align:center;
      border-radius:10px;
      margin-bottom:15px;
    }

    .search-box{
      width:100%;
      padding:12px;
      border:1px solid #ccc;
      border-radius:8px;
      margin-bottom:10px;
    }

    .user-list{
      max-height:70vh;
      overflow-y:auto;
      background:white;
      padding:10px;
      border-radius:10px;
      box-shadow:0 0 10px #ff9ac7;
    }

    .user-box{
      padding:10px;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .wallet-btn{
      background:#ff1493;
      color:white;
      border:none;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
    }

    .help-btn{
      margin-top:15px;
      width:100%;
      padding:12px;
      background:#ff1493;
      color:white;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<div class="topbar">Admin Panel</div>

<input id="search" onkeyup="filterUsers()" class="search-box" placeholder="Search users by name, email...">

<div class="user-list" id="userList">
  Loading users...
</div>

<button class="help-btn" onclick="goHelp()">Help & Support</button>

<script>

auth.onAuthStateChanged(async (user)=>{
   if(!user){
     window.location="login.html";
     return;
   }

   if(user.email !== "sathimere.admin@gmail.com"){
     alert("Access Denied!");
     window.location="index.html";
     return;
   }

   loadUsers();
});


/* ---------------- LOAD USERS ---------------- */
function loadUsers(){
  db.collection("users").orderBy("createdAt","desc").onSnapshot(res=>{
    
    let html = "";
    res.forEach(doc=>{
      let u = doc.data();

      html += `
        <div class="user-box">
          <div>
            <b>${u.name} ${u.surname}</b><br>
            <small>${u.email}</small><br>
            <small>Wallet: â‚¹${u.wallet}</small>
          </div>

          <button class="wallet-btn" onclick="editWallet('${doc.id}', ${u.wallet})">
            Edit
          </button>
        </div>
      `;
    });

    document.getElementById("userList").innerHTML = html;
  });
}


/* ---------------- WALLET EDIT ---------------- */
function editWallet(uid, oldBal){
  let newBal = prompt("Enter new wallet amount:", oldBal);

  if(newBal === null || newBal === "") return;

  db.collection("users").doc(uid).update({
    wallet: Number(newBal)
  })
  .then(()=> alert("Wallet updated!"))
  .catch(err=> alert(err.message));
}


/* ---------------- SEARCH USERS ---------------- */
function filterUsers(){
  let filter = search.value.toLowerCase();
  let users = document.querySelectorAll(".user-box");

  users.forEach(u=>{
    let text = u.innerText.toLowerCase();
    u.style.display = text.includes(filter) ? "flex" : "none";
  });
}


/* ---------------- HELP REDIRECT ---------------- */
function goHelp(){
  window.location = "adminhelp.html";
}

</script>

</body>
</html>
