<!DOCTYPE html>
<html>
<head>
<title>Admin Panel - Sathi Mere</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<style>
body{
  font-family: Arial;
  background:#ffe4f0;
  padding:15px;
}

/* Top bar */
.topbar{
  background:#ff1493;
  padding:12px;
  color:white;
  font-size:20px;
  text-align:center;
  border-radius:10px;
  margin-bottom:15px;
}

/* Search Box */
.search-box{
  width:100%;
  padding:12px;
  border:1px solid #ccc;
  border-radius:8px;
  margin-bottom:10px;
}

/* User list */
.user-list{
  max-height:70vh;
  overflow-y:auto;
  background:white;
  padding:10px;
  border-radius:10px;
  box-shadow:0 0 10px #ff9ac7;
}

/* Each user row */
.user-box{
  padding:12px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* Buttons */
.btn{
  background:#ff1493;
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  margin-left:5px;
}

/* Help button */
.help-btn{
  margin-top:15px;
  width:100%;
  padding:12px;
  background:#ff1493;
  color:white;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

/* Popup Modal */
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-content{
  background:white;
  padding:20px;
  width:90%;
  max-width:400px;
  border-radius:10px;
}
</style>

</head>
<body>

<div class="topbar">Admin Panel</div>

<input id="search" onkeyup="filterUsers()" class="search-box" placeholder="Search users...">

<div class="user-list" id="userList">Loading users...</div>

<button class="help-btn" onclick="goHelp()">Help & Support</button>

<!-- Profile Popup Modal -->
<div id="modal" class="modal">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>

/* ---------------- ADMIN LOGIN CHECK ---------------- */
auth.onAuthStateChanged((user)=>{
   if(!user){
     window.location="login.html";
     return;
   }

   if(user.email !== "sathimere.admin@gmail.com"){
     alert("Access Denied!");
     window.location="index.html";
     return;
   }

   loadUsers();
});


/* ---------------- LOAD USERS (SORT BY WALLET DESC) ---------------- */
function loadUsers(){
  db.collection("users")
  .orderBy("wallet", "desc")   // ðŸ‘ˆ sabse zyada wallet upar
  .onSnapshot(res=>{

    let html = "";
    res.forEach(doc=>{
      let u = doc.data();

      html += `
        <div class="user-box">
          <div>
            <b>${u.name} ${u.surname}</b><br>
            <small>${u.email}</small><br>
            <small>Wallet: â‚¹${u.wallet}</small>
          </div>

          <div>
            <button class="btn" onclick="viewProfile('${doc.id}')">View</button>
            <button class="btn" onclick="editWallet('${doc.id}', ${u.wallet})">Wallet</button>
            <button class="btn" onclick="deleteUser('${doc.id}')">Delete</button>
          </div>
        </div>
      `;
    });

    document.getElementById("userList").innerHTML = html;
  });
}


/* ---------------- VIEW FULL PROFILE ---------------- */
async function viewProfile(uid){
    let d = await db.collection("users").doc(uid).get();
    if(!d.exists) return;
    let u = d.data();

    document.getElementById("modalContent").innerHTML = `
      <h3>${u.name} ${u.surname}</h3>
      <b>Email:</b> ${u.email}<br>
      <b>Gender:</b> ${u.gender}<br>
      <b>Age:</b> ${u.age}<br>
      <b>Location:</b> ${u.city}, ${u.state}<br><br>
      <b>Wallet:</b> â‚¹${u.wallet}<br><br>

      <button class="btn" onclick="closeModal()">Close</button>
    `;

    document.getElementById("modal").style.display="flex";
}

function closeModal(){
  document.getElementById("modal").style.display="none";
}


/* ---------------- WALLET EDIT ---------------- */
function editWallet(uid, oldBal){
  let newBal = prompt("Enter new wallet amount:", oldBal);
  if(newBal === null || newBal === "") return;

  db.collection("users").doc(uid).update({
    wallet: Number(newBal)
  })
  .then(()=> alert("Wallet updated!"));
}


/* ---------------- DELETE USER ---------------- */
function deleteUser(uid){
  if(!confirm("Delete this user permanently?")) return;

  db.collection("users").doc(uid).delete()
  .then(()=> alert("User deleted!"));
}


/* ---------------- SEARCH USERS ---------------- */
function filterUsers(){
  let filter = search.value.toLowerCase();
  let users = document.querySelectorAll(".user-box");

  users.forEach(u=>{
    let text = u.innerText.toLowerCase();
    u.style.display = text.includes(filter) ? "flex" : "none";
  });
}


/* ---------------- HELP REDIRECT ---------------- */
function goHelp(){
  window.location = "help-admin.html";
}

</script>

</body>
</html>
