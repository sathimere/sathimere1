<!DOCTYPE html>
<html>
<head>
<title>Referral System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<style>
body { 
    font-family: Arial; 
    background: #ffe4f0;
    margin:0; 
    padding:20px;
}

.box {
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 0 10px #ffb6d5;
}

.btn {
    background:#ff1493;
    padding:10px 15px;
    color:white;
    border:none;
    border-radius:10px;
    margin-top:10px;
    width:100%;
    font-size:17px;
    cursor:pointer;
}

.input {
    width:100%;
    padding:12px;
    border:2px solid #ff1493;
    border-radius:10px;
    margin-top:10px;
    font-size:17px;
}

.code-box {
    background:#fff0fa;
    padding:12px;
    border:2px dashed #ff1493;
    text-align:center;
    font-size:20px;
    font-weight:bold;
    border-radius:10px;
    margin-bottom:10px;
}
</style>
</head>
<body>

<div class="box">
<h2 style="color:#ff1493; text-align:center;">üéÅ Referral Program</h2>

<div id="myCodeBox" class="code-box">Loading...</div>

<button class="btn" onclick="copyCode()">Copy Code</button>

<h3 style="margin-top:20px; color:#ff1493;">Enter Referral Code</h3>
<input id="refInput" class="input" placeholder="Enter friend's code">

<button class="btn" onclick="applyReferral()">Apply Code</button>

</div>

<script>

auth.onAuthStateChanged(async (u)=>{
    if(!u) return location.href='login.html';
    loadMyReferral(u.uid);
});

/* LOAD MY CODE */
async function loadMyReferral(uid){
    let doc = await db.collection("users").doc(uid).get();
    
    // If user has no referral code, create one
    if(!doc.data().refCode){
        let newCode = uid.slice(0,6).toUpperCase();
        await db.collection("users").doc(uid).update({ refCode:newCode });
        document.getElementById("myCodeBox").innerText = newCode;
    } else {
        document.getElementById("myCodeBox").innerText = doc.data().refCode;
    }
}

/* COPY CODE */
function copyCode(){
    let text = document.getElementById("myCodeBox").innerText;
    navigator.clipboard.writeText(text);
    alert("Referral code copied!");
}

/* APPLY REFERRAL */
async function applyReferral(){

    let code = document.getElementById("refInput").value.trim();
    let me = auth.currentUser.uid;

    if(code === ""){
        alert("Please enter a code");
        return;
    }

    let myData = await db.collection("users").doc(me).get();
    if(myData.data().refUsed){
        alert("Referral already used!");
        return;
    }

    let userSnap = await db.collection("users")
        .where("refCode","==",code)
        .get();

    if(userSnap.empty){
        alert("Invalid code!");
        return;
    }

    let refUser = userSnap.docs[0].id;

    if(refUser === me){
        alert("You cannot use your own code!");
        return;
    }

    // Bonus amount (set your own)
    let bonus = 20;

    // Add bonus to referred user
    await db.collection("wallet").doc(refUser).set({
        balance: firebase.firestore.FieldValue.increment(bonus)
    }, { merge:true });

    // Add bonus to new user
    await db.collection("wallet").doc(me).set({
        balance: firebase.firestore.FieldValue.increment(bonus)
    }, { merge:true });

    // Mark referral used
    await db.collection("users").doc(me).update({
        refUsed: true,
        refBy: refUser
    });

    alert("Referral applied! You both earned ‚Çπ"+bonus);
}

</script>

</body>
</html>
