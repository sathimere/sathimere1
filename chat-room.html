<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Chat Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<!-- Your Config -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNujpIBIvJXMk34yQF1VeuTVFi5M7vdc0",
  authDomain: "sathimere-415fa.firebaseapp.com",
  databaseURL: "https://sathimere-415fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sathimere-415fa",
  storageBucket: "sathimere-415fa.firebasestorage.app",
  messagingSenderId: "290492321074",
  appId: "1:290492321074:web:05aa3d9abc2d3ab7635b2b"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();
</script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }

/* TOP BAR */
.topbar {
  height:70px;
  background:#ff1493;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  position:fixed;
  top:0;
  width:100%;
  z-index:10;
  flex-direction:column;
  padding-top:5px;
}
.topbar span:first-child {
  position:absolute; 
  left:15px; 
  cursor:pointer; 
  font-size:24px;
  top:15px;
}
#chatUserName { font-size:16px; font-weight:bold; margin-top:5px; cursor:pointer; }
#statusBar { font-size:12px; }

/* CHAT */
.chat-container {
  padding:90px 10px 140px;
  max-width:600px;
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msg {
  padding:10px 15px;
  border-radius:15px;
  max-width:80%;
  word-wrap:break-word;
  position:relative;
}
.sender { background:#ff1493; color:#fff; align-self:flex-end; border-bottom-right-radius:0; }
.receiver { background:#fff; color:#333; align-self:flex-start; border-bottom-left-radius:0; }
.seen { font-size:10px; color:#eee; position:absolute; bottom:2px; right:5px; }
.timestamp { font-size:10px; color:#666; position:absolute; bottom:2px; left:5px; }

/* INPUT BOX */
.input-container {
  position:fixed;
  bottom:0;
  width:100%;
  background:#fff;
  display:flex;
  padding:8px;
  box-shadow:0 -3px 10px rgba(0,0,0,0.1);
  gap:5px;
}
.input-container input {
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
  outline:none;
}
.input-container button {
  background:#ff1493;
  color:#fff;
  border:none;
  border-radius:20px;
  padding:10px 15px;
  cursor:pointer;
  font-weight:bold;
}

/* Typing */
.typing-indicator {
  font-size:14px;
  color:#666;
  margin-left:10px;
  display:none;
}

/* BLOCK BUTTON */
#blockBtn {
  position:fixed;
  bottom:70px;
  right:10px;
  background:black;
  color:white;
  padding:10px 15px;
  border-radius:20px;
  font-size:14px;
  cursor:pointer;
  z-index:20;
}
</style>
</head>

<body>

<div class="topbar">
  <span onclick="goBack()">←</span>
  <div id="chatUserName">Loading...</div>
  <div id="statusBar">Loading...</div>
</div>

<div class="chat-container" id="chatList">Loading...</div>
<div class="typing-indicator" id="typingIndicator">Typing...</div>

<div class="input-container">
  <input type="text" id="msgInput" placeholder="Type a message..." oninput="updateTyping(true)">
  <button onclick="sendMessage()">Send</button>
</div>

<button id="blockBtn" onclick="toggleBlock()">Loading...</button>

<script>
let CURRENT = null;
let CHAT_ID = null;
let OTHER_ID = null;
let BLOCKED_BY = null;
let typingTimeout;

/* SOUND */
const msgSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

/* Format Last Seen (WhatsApp Style) */
function formatLastSeen(time){
  const d = new Date(time);
  const now = new Date();

  const t = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

  const daysDiff = Math.floor((now - d) / (1000*60*60*24));

  if(daysDiff === 0){
    return "Last seen today at " + t;
  }
  else if(daysDiff === 1){
    return "Last seen yesterday at " + t;
  }
  else {
    return "Last seen on " + d.toLocaleDateString("en-GB",{day:"2-digit",month:"short"}) + " at " + t;
  }
}

/* BACK */
function goBack(){
  db.collection("chats").doc(CHAT_ID).update({
    [CURRENT.uid+"_online"]:false,
    lastSeen:Date.now()
  });
  location.href="chat.html";
}

/* INIT */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";
  CURRENT = user;

  const params = new URLSearchParams(window.location.search);
  CHAT_ID = params.get("id");

  const parts = CHAT_ID.split("_");
  OTHER_ID = parts[0]===CURRENT.uid ? parts[1] : parts[0];

  /* Load user name in top bar */
  const u = await db.collection("users").doc(OTHER_ID).get();
  if(u.exists){
    document.getElementById("chatUserName").innerText = u.data().name + " " + u.data().surname;
  }

  /* CLICK → OPEN PROFILE */
  document.getElementById("chatUserName").onclick = () => {
    location.href = "view-profile.html?uid=" + OTHER_ID;
  };

  /* Set Online */
  db.collection("chats").doc(CHAT_ID).update({
    [CURRENT.uid+"_online"]:true,
    lastSeen:Date.now()
  });

  loadStatus();
  loadMessages();
  listenTyping();
  loadBlockStatus();
});

/* STATUS BAR */
function loadStatus(){
  db.collection("chats").doc(CHAT_ID).onSnapshot(doc=>{
    const d = doc.data();
    const online = d[OTHER_ID+"_online"];
    const ls = d.lastSeen || 0;

    if(online){
      statusBar.innerText = "Online";
    } else {
      statusBar.innerText = formatLastSeen(ls);
    }
  });
}

/* LOAD BLOCK STATUS */
function loadBlockStatus(){
  db.collection("blocks").doc(CHAT_ID).onSnapshot(doc=>{
    BLOCKED_BY = doc.exists ? doc.data().blockedBy : null;
    updateBlockButton();
  });
}

function updateBlockButton(){
  const btn = document.getElementById("blockBtn");

  if(BLOCKED_BY === CURRENT.uid){
    btn.innerText = "Unblock";
    btn.style.background = "green";
  } 
  else if(BLOCKED_BY === OTHER_ID){
    btn.innerText = "Blocked";
    btn.style.background = "gray";
    btn.disabled = true;
  }
  else {
    btn.innerText = "Block";
    btn.style.background = "black";
    btn.disabled = false;
  }
}

/* TOGGLE BLOCK */
function toggleBlock(){
  if(BLOCKED_BY === CURRENT.uid){
    db.collection("blocks").doc(CHAT_ID).delete();
  } else {
    db.collection("blocks").doc(CHAT_ID).set({
      blockedBy: CURRENT.uid
    });
  }
}

/* LOAD MESSAGES */
function loadMessages(){
  const chatList = document.getElementById("chatList");

  db.collection("chats").doc(CHAT_ID).collection("messages")
    .orderBy("time","asc")
    .onSnapshot(snapshot=>{
      chatList.innerHTML = "";
      snapshot.forEach(mDoc=>{
        const m = mDoc.data();
        const box = document.createElement("div");
        box.className = "msg " + (m.from === CURRENT.uid ? "sender" : "receiver");
        box.innerText = m.text;

        const t = document.createElement("span");
        t.className="timestamp";
        t.innerText = new Date(m.time).toLocaleTimeString();
        box.appendChild(t);

        if(m.from === CURRENT.uid){
          const s = document.createElement("span");
          s.className="seen";
          s.innerText = m.seen?"Seen":"Sent";
          box.appendChild(s);
        } 
        else {
          if(!m.seen){
            db.collection("chats").doc(CHAT_ID).collection("messages")
              .doc(mDoc.id).update({seen:true});
          }
          msgSound.play();
        }

        chatList.appendChild(box);
      });

      chatList.scrollTop = chatList.scrollHeight;
    });
}

/* SEND MSG */
async function sendMessage(){
  if(BLOCKED_BY === OTHER_ID){
    alert("You cannot send message. You are blocked!");
    return;
  }

  const input = msgInput.value.trim();
  if(!input) return;

  msgInput.value = "";

  db.collection("chats").doc(CHAT_ID).collection("messages").add({
    text:input,
    from:CURRENT.uid,
    to:OTHER_ID,
    time:Date.now(),
    seen:false
  });

  db.collection("chats").doc(CHAT_ID).update({
    lastMsg:input,
    time:Date.now()
  });

  updateTyping(false);
}

/* TYPING */
function updateTyping(state){
  db.collection("chats").doc(CHAT_ID).update({
    [CURRENT.uid+"_typing"]:state
  });

  clearTimeout(typingTimeout);
  if(state){
    typingTimeout=setTimeout(()=>updateTyping(false),2000);
  }
}

function listenTyping(){
  db.collection("chats").doc(CHAT_ID).onSnapshot(doc=>{
    const d = doc.data();
    typingIndicator.style.display = d[OTHER_ID+"_typing"] ? "block" : "none";
  });
}
</script>

</body>
</html>
