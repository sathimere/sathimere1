<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Chat Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
.topbar { height:55px; background:#ff1493; color:#fff; display:flex; align-items:center; justify-content:center; position:fixed; top:0; width:100%; z-index:10; font-size:20px; }
.topbar span:first-child { position:absolute; left:15px; cursor:pointer; font-size:22px; }
.topbar button { position:absolute; right:15px; background:#fff; color:#ff1493; border:none; padding:5px 12px; border-radius:10px; cursor:pointer; font-weight:bold; }

.chat-container { padding:70px 10px 100px; max-width:600px; margin:auto; display:flex; flex-direction:column; gap:10px; }
.msg { padding:10px 15px; border-radius:15px; max-width:80%; word-wrap:break-word; position:relative; }
.sender { background:#ff1493; color:#fff; align-self:flex-end; border-bottom-right-radius:0; }
.receiver { background:#fff; color:#333; align-self:flex-start; border-bottom-left-radius:0; }
.seen { font-size:10px; color:#eee; position:absolute; bottom:2px; right:5px; }
.timestamp { font-size:10px; color:#666; position:absolute; bottom:2px; left:5px; }

.input-container { position:fixed; bottom:0; width:100%; background:#fff; display:flex; padding:8px; box-shadow:0 -3px 10px rgba(0,0,0,0.1); gap:5px; }
.input-container input { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; }
.input-container button { background:#ff1493; color:#fff; border:none; border-radius:20px; padding:10px 15px; cursor:pointer; font-weight:bold; }

.typing-indicator { font-size:14px; color:#666; margin-bottom:5px; margin-left:5px; display:none; }
</style>
</head>
<body>

<div class="topbar">
<span onclick="goBack()">‚Üê</span>
Chat Room
<button id="blockBtn" onclick="toggleBlock()">Block</button>
</div>

<div id="onlineStatus" style="
  font-size:12px;
  position:fixed;
  top:40px;
  width:100%;
  text-align:center;
  color:white;
"></div>

<div class="chat-container" id="chatList">Loading...</div>
<div class="typing-indicator" id="typingIndicator">Typing...</div>

<div class="input-container">
<input type="text" id="msgInput" placeholder="Type a message..." oninput="updateTyping(true)">
<button onclick="sendMessage()">Send</button>
</div>

<script>
let CURRENT = null;
let CHAT_ID = null;
let OTHER_ID = null;
let typingTimeout;
let BLOCKED = false;

/* ----------------------- FORMAT TIME ----------------------- */
function formatTime(ts){
    const d = new Date(ts);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate()-1);

    if(d.toDateString()===today.toDateString())
        return "Today " + d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');

    if(d.toDateString()===yesterday.toDateString())
        return "Yesterday " + d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');

    return (
        d.getDate().toString().padStart(2,'0') + "-" +
        (d.getMonth()+1).toString().padStart(2,'0') + "-" +
        d.getFullYear() + " " +
        d.getHours().toString().padStart(2,'0') + ":" +
        d.getMinutes().toString().padStart(2,'0')
    );
}

/* ----------------------- BACK BUTTON ----------------------- */
function goBack(){ 
    db.collection("chats").doc(CHAT_ID).update({[CURRENT.uid+"_online"]:false});
    location.href="chat.html"; 
}

/* ----------------------- AUTH INIT ----------------------- */
auth.onAuthStateChanged(async user=>{
    if(!user) return location.href="login.html";
    CURRENT = user;

    const params = new URLSearchParams(window.location.search);
    CHAT_ID = params.get("id");
    if(!CHAT_ID) return alert("Invalid Chat Room!");

    const parts = CHAT_ID.split("_");
    OTHER_ID = parts[0]===CURRENT.uid ? parts[1] : parts[0];

    db.collection("chats").doc(CHAT_ID).update({[CURRENT.uid+"_online"]:true});

    const chatDoc = await db.collection("chats").doc(CHAT_ID).get();
    if(chatDoc.exists){
        const data = chatDoc.data();
        BLOCKED = data[CURRENT.uid+"_blocked"] || false;
        document.getElementById("blockBtn").innerText = BLOCKED ? "Unblock" : "Block";
    }

    loadMessages();
    listenTyping();
});

/* ----------------------- LOAD MESSAGES ----------------------- */
function loadMessages(){
    const chatList = document.getElementById("chatList");
    chatList.innerHTML = "";

    db.collection("chats").doc(CHAT_ID).collection("messages")
      .orderBy("time","asc")
      .onSnapshot(snapshot=>{
        chatList.innerHTML = "";

        snapshot.forEach(async doc=>{
            const m = doc.data();
            const div = document.createElement("div");

            div.className = "msg "+(m.from===CURRENT.uid ? "sender" : "receiver");
            div.innerText = m.text;

            if(m.from===CURRENT.uid){
                const seen = document.createElement("span");
                seen.className = "seen";
                seen.innerText = m.seen?"Seen":"Sent";
                div.appendChild(seen);
            } else {
                if(!m.seen){
                    await db.collection("chats").doc(CHAT_ID)
                      .collection("messages").doc(doc.id)
                      .update({seen:true});
                }
            }

            const time = document.createElement("span");
            time.className = "timestamp";
            time.innerText = formatTime(m.time);
            div.appendChild(time);

            chatList.appendChild(div);
        });

        chatList.scrollTop = chatList.scrollHeight;
    });
}

/* ----------------------- SEND MESSAGE ----------------------- */
async function sendMessage(){
    if(BLOCKED){
        alert("You cannot send messages to a blocked user!");
        return;
    }

    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if(!text) return;

    await db.collection("chats").doc(CHAT_ID).collection("messages").add({
        text: text,
        from: CURRENT.uid,
        to: OTHER_ID,
        time: Date.now(),
        seen:false
    });

    await db.collection("chats").doc(CHAT_ID)
      .update({lastMsg:text, time:Date.now()});

    input.value = "";
    updateTyping(false);
}

/* ----------------------- TYPING INDICATOR ----------------------- */
function updateTyping(isTyping){
    db.collection("chats").doc(CHAT_ID).update({
        [CURRENT.uid+"_typing"]:isTyping
    });

    clearTimeout(typingTimeout);

    if(isTyping){
        typingTimeout = setTimeout(() => updateTyping(false),2000);
    }
}

function listenTyping(){
    const indicator = document.getElementById("typingIndicator");

    db.collection("chats").doc(CHAT_ID).onSnapshot(doc=>{
        const data = doc.data();
        if(!data) return;

        indicator.style.display = 
            data[OTHER_ID+"_typing"] ? "block" : "none";
    });
}

/* ----------------------- BLOCK / UNBLOCK ----------------------- */
async function toggleBlock(){
    BLOCKED = !BLOCKED;
    document.getElementById("blockBtn").innerText = BLOCKED ? "Unblock" : "Block";
    await db.collection("chats").doc(CHAT_ID).update({
        [CURRENT.uid+"_blocked"]:BLOCKED
    });
}

/* =============================================================
üîî NOTIFICATION + ONLINE / LAST SEEN SYSTEM
============================================================= */

// Notification sound
const notifySound = new Audio("notify.mp3");

// Update last seen
function updateLastSeen(status){
    db.collection("chats").doc(CHAT_ID).update({
        [CURRENT.uid+"_lastSeen"]: status
    });
}

auth.onAuthStateChanged(user=>{
    if(!user) return;

    window.addEventListener("focus", ()=> updateLastSeen("online"));
    window.addEventListener("blur", ()=> updateLastSeen(Date.now()));
});

/* Online/Last Seen Display */
db.collection("chats").doc(CHAT_ID).onSnapshot(doc=>{
    const data = doc.data();
    if(!data) return;

    let s = data[OTHER_ID+"_lastSeen"];
    let statusDiv = document.getElementById("onlineStatus");

    if(s === "online"){
        statusDiv.innerText = "Online";
    }
    else if(typeof s === "number"){
        const d = new Date(s);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate()-1);

        let time =
            d.getHours().toString().padStart(2,'0') + ":" +
            d.getMinutes().toString().padStart(2,'0');

        if(d.toDateString() === today.toDateString())
            statusDiv.innerText = "Last seen today at " + time;
        else if(d.toDateString() === yesterday.toDateString())
            statusDiv.innerText = "Last seen yesterday at " + time;
        else
            statusDiv.innerText =
                "Last seen " + d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" "+time;
    }
});

/* NEW MESSAGE NOTIFICATION */
let firstLoad = true;

db.collection("chats").doc(CHAT_ID).collection("messages")
.orderBy("time","asc")
.onSnapshot(snapshot=>{
    if(firstLoad){
        firstLoad = false;
        return;
    }

    snapshot.docChanges().forEach(change=>{
        if(change.type === "added"){
            const m = change.doc.data();

            if(m.from === OTHER_ID){
                notifySound.play();
                showPopup("New message: " + m.text);
            }
        }
    });
});

/* Popup Notification */
function showPopup(msg){
    const pop = document.createElement("div");
    pop.innerText = msg;

    pop.style.position = "fixed";
    pop.style.bottom = "80px";
    pop.style.left = "50%";
    pop.style.transform = "translateX(-50%)";
    pop.style.background = "#333";
    pop.style.color = "#fff";
    pop.style.padding = "10px 15px";
    pop.style.borderRadius = "20px";
    pop.style.fontSize = "14px";
    pop.style.opacity = "0";
    pop.style.transition = "0.3s";
    pop.style.zIndex = "999";

    document.body.appendChild(pop);

    setTimeout(()=> pop.style.opacity = "1", 60);

    setTimeout(()=>{
        pop.style.opacity = "0";
        setTimeout(()=> pop.remove(), 300);
    },2000);
}

</script>

</body>
</html>
